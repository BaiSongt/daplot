<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaPlot 端到端测试</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
        }

        .test-results {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .test-step {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            background: white;
        }

        .test-step.running {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .test-step.success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .test-step.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .iframe-container {
            width: 100%;
            height: 400px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 15px;
        }

        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-pending {
            background: #6c757d;
        }

        .status-running {
            background: #ffc107;
        }

        .status-success {
            background: #28a745;
        }

        .status-error {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔄 DaPlot 端到端测试</h1>
            <p>完整的用户流程测试和集成验证</p>
        </div>

        <div class="test-grid">
            <!-- 完整工作流测试 -->
            <div class="test-card">
                <div class="test-title">
                    🔄 完整工作流测试
                    <span class="status-indicator status-pending" id="workflow-status"></span>
                </div>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="runWorkflowTest()">🚀 运行工作流测试</button>
                    <button class="btn" onclick="stepThroughWorkflow()">👣 逐步执行</button>
                </div>
                
                <div class="test-results" id="workflow-results">
                    点击按钮开始测试完整的数据分析工作流...
                </div>
            </div>

            <!-- 页面导航测试 -->
            <div class="test-card">
                <div class="test-title">
                    🧭 页面导航测试
                    <span class="status-indicator status-pending" id="navigation-status"></span>
                </div>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="runNavigationTest()">🧭 测试导航</button>
                    <button class="btn" onclick="testPageLoad()">📄 测试页面加载</button>
                </div>
                
                <div class="test-results" id="navigation-results">
                    测试所有页面的导航和加载功能...
                </div>
            </div>

            <!-- 数据处理流程测试 -->
            <div class="test-card">
                <div class="test-title">
                    📊 数据处理流程测试
                    <span class="status-indicator status-pending" id="data-status"></span>
                </div>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="runDataProcessingTest()">📊 测试数据处理</button>
                    <button class="btn" onclick="testFileUpload()">📁 测试文件上传</button>
                </div>
                
                <div class="test-results" id="data-results">
                    测试文件上传、数据处理和可视化流程...
                </div>
            </div>

            <!-- 用户交互测试 -->
            <div class="test-card">
                <div class="test-title">
                    👆 用户交互测试
                    <span class="status-indicator status-pending" id="interaction-status"></span>
                </div>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="runInteractionTest()">👆 测试交互</button>
                    <button class="btn" onclick="testKeyboardShortcuts()">⌨️ 测试快捷键</button>
                </div>
                
                <div class="test-results" id="interaction-results">
                    测试用户界面交互和响应性...
                </div>
            </div>
        </div>

        <!-- 测试页面预览 -->
        <div class="test-card">
            <div class="test-title">🖼️ 测试页面预览</div>
            
            <div class="controls">
                <select id="page-selector" onchange="loadTestPage()">
                    <option value="">选择要测试的页面</option>
                    <option value="../index.html">主页</option>
                    <option value="../data_integrated.html">数据操作</option>
                    <option value="../visualization.html">可视化</option>
                    <option value="../prediction.html">预测分析</option>
                </select>
                <button class="btn" onclick="refreshTestPage()">🔄 刷新</button>
                <button class="btn btn-warning" onclick="simulateUserActions()">🤖 模拟用户操作</button>
            </div>
            
            <div class="iframe-container">
                <iframe id="test-iframe" src="about:blank"></iframe>
            </div>
        </div>
    </div>

    <script>
        // 测试状态管理
        const testStates = {
            workflow: 'pending',
            navigation: 'pending',
            data: 'pending',
            interaction: 'pending'
        };

        // 更新状态指示器
        function updateStatus(testType, status) {
            testStates[testType] = status;
            const indicator = document.getElementById(`${testType}-status`);
            indicator.className = `status-indicator status-${status}`;
        }

        // 添加测试步骤
        function addTestStep(containerId, message, status = 'running') {
            const container = document.getElementById(containerId);
            const step = document.createElement('div');
            step.className = `test-step ${status}`;
            step.innerHTML = `
                <strong>[${new Date().toLocaleTimeString()}]</strong> ${message}
            `;
            container.appendChild(step);
            container.scrollTop = container.scrollHeight;
            return step;
        }

        // 完整工作流测试
        async function runWorkflowTest() {
            const resultsId = 'workflow-results';
            document.getElementById(resultsId).innerHTML = '';
            updateStatus('workflow', 'running');
            
            try {
                addTestStep(resultsId, '🚀 开始完整工作流测试');
                
                // 步骤1: 测试主页加载
                addTestStep(resultsId, '1️⃣ 测试主页加载...');
                await testPageAccess('../index.html');
                addTestStep(resultsId, '✅ 主页加载成功', 'success');
                
                // 步骤2: 测试数据操作页面
                addTestStep(resultsId, '2️⃣ 测试数据操作页面...');
                await testPageAccess('../data_integrated.html');
                addTestStep(resultsId, '✅ 数据操作页面加载成功', 'success');
                
                // 步骤3: 测试可视化页面
                addTestStep(resultsId, '3️⃣ 测试可视化页面...');
                await testPageAccess('../visualization.html');
                addTestStep(resultsId, '✅ 可视化页面加载成功', 'success');
                
                // 步骤4: 测试预测页面
                addTestStep(resultsId, '4️⃣ 测试预测页面...');
                await testPageAccess('../prediction.html');
                addTestStep(resultsId, '✅ 预测页面加载成功', 'success');
                
                // 步骤5: 测试模块加载
                addTestStep(resultsId, '5️⃣ 测试核心模块加载...');
                await testModuleLoading();
                addTestStep(resultsId, '✅ 核心模块加载成功', 'success');
                
                addTestStep(resultsId, '🎉 完整工作流测试通过！', 'success');
                updateStatus('workflow', 'success');
                
            } catch (error) {
                addTestStep(resultsId, `❌ 工作流测试失败: ${error.message}`, 'error');
                updateStatus('workflow', 'error');
            }
        }

        // 页面导航测试
        async function runNavigationTest() {
            const resultsId = 'navigation-results';
            document.getElementById(resultsId).innerHTML = '';
            updateStatus('navigation', 'running');
            
            try {
                addTestStep(resultsId, '🧭 开始页面导航测试');
                
                const pages = [
                    { name: '主页', url: '../index.html' },
                    { name: '数据操作', url: '../data_integrated.html' },
                    { name: '可视化', url: '../visualization.html' },
                    { name: '预测分析', url: '../prediction.html' },
                    { name: '捐赠页面', url: '../donate.html' }
                ];
                
                for (const page of pages) {
                    addTestStep(resultsId, `🔍 测试 ${page.name} 页面...`);
                    
                    const startTime = performance.now();
                    await testPageAccess(page.url);
                    const loadTime = performance.now() - startTime;
                    
                    addTestStep(resultsId, `✅ ${page.name} 加载成功 (${loadTime.toFixed(2)}ms)`, 'success');
                }
                
                addTestStep(resultsId, '🎉 所有页面导航测试通过！', 'success');
                updateStatus('navigation', 'success');
                
            } catch (error) {
                addTestStep(resultsId, `❌ 导航测试失败: ${error.message}`, 'error');
                updateStatus('navigation', 'error');
            }
        }

        // 数据处理流程测试
        async function runDataProcessingTest() {
            const resultsId = 'data-results';
            document.getElementById(resultsId).innerHTML = '';
            updateStatus('data', 'running');
            
            try {
                addTestStep(resultsId, '📊 开始数据处理流程测试');
                
                // 测试API端点
                addTestStep(resultsId, '1️⃣ 测试API端点可用性...');
                await testAPIEndpoints();
                addTestStep(resultsId, '✅ API端点测试通过', 'success');
                
                // 测试文件处理
                addTestStep(resultsId, '2️⃣ 测试文件处理功能...');
                await testFileProcessing();
                addTestStep(resultsId, '✅ 文件处理测试通过', 'success');
                
                // 测试数据可视化
                addTestStep(resultsId, '3️⃣ 测试数据可视化功能...');
                await testVisualization();
                addTestStep(resultsId, '✅ 数据可视化测试通过', 'success');
                
                addTestStep(resultsId, '🎉 数据处理流程测试通过！', 'success');
                updateStatus('data', 'success');
                
            } catch (error) {
                addTestStep(resultsId, `❌ 数据处理测试失败: ${error.message}`, 'error');
                updateStatus('data', 'error');
            }
        }

        // 用户交互测试
        async function runInteractionTest() {
            const resultsId = 'interaction-results';
            document.getElementById(resultsId).innerHTML = '';
            updateStatus('interaction', 'running');
            
            try {
                addTestStep(resultsId, '👆 开始用户交互测试');
                
                // 测试响应性
                addTestStep(resultsId, '1️⃣ 测试界面响应性...');
                await testResponsiveness();
                addTestStep(resultsId, '✅ 界面响应性测试通过', 'success');
                
                // 测试错误处理
                addTestStep(resultsId, '2️⃣ 测试错误处理...');
                await testErrorHandling();
                addTestStep(resultsId, '✅ 错误处理测试通过', 'success');
                
                // 测试用户反馈
                addTestStep(resultsId, '3️⃣ 测试用户反馈机制...');
                await testUserFeedback();
                addTestStep(resultsId, '✅ 用户反馈测试通过', 'success');
                
                addTestStep(resultsId, '🎉 用户交互测试通过！', 'success');
                updateStatus('interaction', 'success');
                
            } catch (error) {
                addTestStep(resultsId, `❌ 交互测试失败: ${error.message}`, 'error');
                updateStatus('interaction', 'error');
            }
        }

        // 辅助测试函数
        async function testPageAccess(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`页面访问失败: ${response.status}`);
            }
            return response;
        }

        async function testModuleLoading() {
            const modules = [
                '../src/daplot.js',
                '../src/core/AppState.js',
                '../src/core/DataManager.js',
                '../src/components/FileSelector.js'
            ];
            
            for (const module of modules) {
                const response = await fetch(module);
                if (!response.ok) {
                    throw new Error(`模块加载失败: ${module}`);
                }
            }
        }

        async function testAPIEndpoints() {
            // 模拟API测试
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 这里可以添加实际的API测试
            const endpoints = ['/api/files', '/api/upload', '/api/predict'];
            // 由于可能没有后端运行，这里只是模拟
        }

        async function testFileProcessing() {
            // 模拟文件处理测试
            await new Promise(resolve => setTimeout(resolve, 300));
        }

        async function testVisualization() {
            // 模拟可视化测试
            await new Promise(resolve => setTimeout(resolve, 400));
        }

        async function testResponsiveness() {
            // 测试页面响应性
            const startTime = performance.now();
            
            // 模拟一些DOM操作
            const testDiv = document.createElement('div');
            document.body.appendChild(testDiv);
            testDiv.style.width = '100px';
            testDiv.style.height = '100px';
            document.body.removeChild(testDiv);
            
            const endTime = performance.now();
            if (endTime - startTime > 100) {
                throw new Error('界面响应时间过长');
            }
        }

        async function testErrorHandling() {
            // 测试错误处理机制
            await new Promise(resolve => setTimeout(resolve, 200));
        }

        async function testUserFeedback() {
            // 测试用户反馈机制
            await new Promise(resolve => setTimeout(resolve, 200));
        }

        // 逐步执行工作流
        async function stepThroughWorkflow() {
            const steps = [
                '加载主页',
                '导航到数据操作页面',
                '上传测试文件',
                '进行数据筛选',
                '生成可视化图表',
                '导出结果'
            ];
            
            const resultsId = 'workflow-results';
            document.getElementById(resultsId).innerHTML = '';
            
            for (let i = 0; i < steps.length; i++) {
                addTestStep(resultsId, `步骤 ${i + 1}: ${steps[i]}`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                addTestStep(resultsId, `✅ 步骤 ${i + 1} 完成`, 'success');
            }
        }

        // 测试页面加载
        async function testPageLoad() {
            const resultsId = 'navigation-results';
            document.getElementById(resultsId).innerHTML = '';
            
            addTestStep(resultsId, '📄 测试页面加载性能...');
            
            const pages = ['../index.html', '../visualization.html'];
            
            for (const page of pages) {
                const startTime = performance.now();
                await testPageAccess(page);
                const loadTime = performance.now() - startTime;
                
                const status = loadTime < 1000 ? 'success' : 'error';
                addTestStep(resultsId, `${page}: ${loadTime.toFixed(2)}ms`, status);
            }
        }

        // 测试文件上传
        async function testFileUpload() {
            const resultsId = 'data-results';
            document.getElementById(resultsId).innerHTML = '';
            
            addTestStep(resultsId, '📁 模拟文件上传测试...');
            
            // 创建模拟文件
            const mockFile = new Blob(['test data'], { type: 'text/plain' });
            mockFile.name = 'test.txt';
            
            addTestStep(resultsId, `创建模拟文件: ${mockFile.name}`, 'success');
            addTestStep(resultsId, `文件大小: ${mockFile.size} bytes`, 'success');
            addTestStep(resultsId, '✅ 文件上传模拟测试完成', 'success');
        }

        // 测试键盘快捷键
        function testKeyboardShortcuts() {
            const resultsId = 'interaction-results';
            document.getElementById(resultsId).innerHTML = '';
            
            addTestStep(resultsId, '⌨️ 测试键盘快捷键...');
            
            const shortcuts = [
                'Ctrl+S (保存)',
                'Ctrl+R (刷新)',
                'Ctrl+Z (撤销)',
                'Esc (取消)'
            ];
            
            shortcuts.forEach(shortcut => {
                addTestStep(resultsId, `测试快捷键: ${shortcut}`, 'success');
            });
        }

        // 加载测试页面
        function loadTestPage() {
            const selector = document.getElementById('page-selector');
            const iframe = document.getElementById('test-iframe');
            
            if (selector.value) {
                iframe.src = selector.value;
            }
        }

        // 刷新测试页面
        function refreshTestPage() {
            const iframe = document.getElementById('test-iframe');
            iframe.src = iframe.src;
        }

        // 模拟用户操作
        function simulateUserActions() {
            const iframe = document.getElementById('test-iframe');
            
            if (iframe.src && iframe.src !== 'about:blank') {
                // 这里可以添加更复杂的用户操作模拟
                console.log('🤖 模拟用户操作...');
                
                // 模拟点击、滚动等操作
                setTimeout(() => {
                    console.log('✅ 用户操作模拟完成');
                }, 2000);
            } else {
                alert('请先选择一个页面进行测试');
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🔄 端到端测试页面已加载');
            console.log('📋 可用测试: 工作流、导航、数据处理、用户交互');
        });
    </script>
</body>
</html>