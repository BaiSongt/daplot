<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaPlot å•å…ƒæµ‹è¯•</title>
    
    <!-- æµ‹è¯•æ¡†æ¶ -->
    <script src="unit-test-framework.js"></script>
    
    <!-- è¢«æµ‹è¯•çš„æ¨¡å— -->
    <script src="../src/utils/constants.js"></script>
    <script src="../src/utils/helpers.js"></script>
    <script src="../src/utils/validators.js"></script>
    <script src="../src/utils/formatters.js"></script>
    <script src="../src/utils/cache.js"></script>
    <script src="../src/utils/performance.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
        }

        .test-controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .results-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .test-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }

        .stat-passed {
            color: #28a745;
        }

        .stat-failed {
            color: #dc3545;
        }

        .stat-total {
            color: #007bff;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            background: #28a745;
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª DaPlot å•å…ƒæµ‹è¯•</h1>
            <p>å…¨é¢çš„æ¨¡å—å’Œç»„ä»¶å•å…ƒæµ‹è¯•å¥—ä»¶</p>
        </div>

        <div class="test-controls">
            <h3>æµ‹è¯•æ§åˆ¶</h3>
            <button class="btn btn-success" onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button class="btn" onclick="runUtilsTests()">ğŸ”§ å·¥å…·å‡½æ•°æµ‹è¯•</button>
            <button class="btn" onclick="runCacheTests()">ğŸ’¾ ç¼“å­˜æµ‹è¯•</button>
            <button class="btn" onclick="runPerformanceTests()">âš¡ æ€§èƒ½æµ‹è¯•</button>
            <button class="btn btn-warning" onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
            <button class="btn btn-danger" onclick="runFailureTests()">âŒ å¤±è´¥æµ‹è¯•</button>
        </div>

        <div class="results-container">
            <h3>æµ‹è¯•ç»“æœ</h3>
            
            <div class="stats-grid" id="stats-grid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value stat-total" id="total-tests">0</div>
                    <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-passed" id="passed-tests">0</div>
                    <div class="stat-label">é€šè¿‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-failed" id="failed-tests">0</div>
                    <div class="stat-label">å¤±è´¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pass-rate">0%</div>
                    <div class="stat-label">é€šè¿‡ç‡</div>
                </div>
            </div>

            <div class="progress-bar" id="progress-bar" style="display: none;">
                <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
            </div>

            <div class="test-output" id="test-output">
                ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è¿è¡Œæµ‹è¯•...
            </div>
        </div>
    </div>

    <script>
        // é‡å®šå‘console.logåˆ°æµ‹è¯•è¾“å‡º
        const originalLog = console.log;
        const originalError = console.error;
        const testOutput = document.getElementById('test-output');

        function logToOutput(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'warn' ? 'âš ï¸' : 'â„¹ï¸';
            testOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            testOutput.scrollTop = testOutput.scrollHeight;
        }

        console.log = (...args) => {
            originalLog(...args);
            logToOutput(args.join(' '));
        };

        console.error = (...args) => {
            originalError(...args);
            logToOutput(args.join(' '), 'error');
        };

        // å·¥å…·å‡½æ•°æµ‹è¯•
        function defineUtilsTests() {
            describe('å·¥å…·å‡½æ•°æµ‹è¯•', () => {
                describe('helpers.js', () => {
                    it('åº”è¯¥æ­£ç¡®æ ¼å¼åŒ–æ–‡ä»¶å¤§å°', () => {
                        if (typeof formatFileSize !== 'undefined') {
                            expect(formatFileSize(1024)).toBe('1.00 KB');
                            expect(formatFileSize(1048576)).toBe('1.00 MB');
                        }
                    });

                    it('åº”è¯¥æ­£ç¡®ç”ŸæˆUUID', () => {
                        if (typeof generateUUID !== 'undefined') {
                            const uuid = generateUUID();
                            expect(uuid).toHaveProperty('length');
                            expect(uuid.length).toBe(36);
                        }
                    });
                });

                describe('validators.js', () => {
                    it('åº”è¯¥æ­£ç¡®éªŒè¯é‚®ç®±æ ¼å¼', () => {
                        if (typeof validateEmail !== 'undefined') {
                            expect(validateEmail('test@example.com')).toBeTruthy();
                            expect(validateEmail('invalid-email')).toBeFalsy();
                        }
                    });

                    it('åº”è¯¥æ­£ç¡®éªŒè¯æ–‡ä»¶ç±»å‹', () => {
                        if (typeof validateFileType !== 'undefined') {
                            expect(validateFileType('test.xlsx', ['.xlsx', '.xls'])).toBeTruthy();
                            expect(validateFileType('test.txt', ['.xlsx', '.xls'])).toBeFalsy();
                        }
                    });
                });

                describe('formatters.js', () => {
                    it('åº”è¯¥æ­£ç¡®æ ¼å¼åŒ–æ—¥æœŸ', () => {
                        if (typeof formatDate !== 'undefined') {
                            const date = new Date('2024-01-01');
                            const formatted = formatDate(date);
                            expect(formatted).toContain('2024');
                        }
                    });

                    it('åº”è¯¥æ­£ç¡®æ ¼å¼åŒ–æ•°å­—', () => {
                        if (typeof formatNumber !== 'undefined') {
                            expect(formatNumber(1234.567, 2)).toBe('1,234.57');
                        }
                    });
                });
            });
        }

        // ç¼“å­˜ç³»ç»Ÿæµ‹è¯•
        function defineCacheTests() {
            describe('ç¼“å­˜ç³»ç»Ÿæµ‹è¯•', () => {
                let testCache;

                beforeEach(() => {
                    if (typeof CacheManager !== 'undefined') {
                        testCache = new CacheManager({ maxSize: 5, defaultTTL: 1000 });
                    }
                });

                it('åº”è¯¥èƒ½å¤Ÿè®¾ç½®å’Œè·å–ç¼“å­˜', () => {
                    if (testCache) {
                        testCache.set('test-key', 'test-value');
                        expect(testCache.get('test-key')).toBe('test-value');
                    }
                });

                it('åº”è¯¥æ­£ç¡®å¤„ç†ç¼“å­˜è¿‡æœŸ', async () => {
                    if (testCache) {
                        testCache.set('expire-key', 'expire-value', 100);
                        expect(testCache.get('expire-key')).toBe('expire-value');
                        
                        await new Promise(resolve => setTimeout(resolve, 150));
                        expect(testCache.get('expire-key')).toBe(null);
                    }
                });

                it('åº”è¯¥æ­£ç¡®æ‰§è¡ŒLRUæ¸…ç†', () => {
                    if (testCache) {
                        // å¡«æ»¡ç¼“å­˜
                        for (let i = 0; i < 5; i++) {
                            testCache.set(`key-${i}`, `value-${i}`);
                        }
                        
                        // æ·»åŠ ç¬¬6ä¸ªé¡¹ç›®ï¼Œåº”è¯¥è§¦å‘LRUæ¸…ç†
                        testCache.set('key-6', 'value-6');
                        expect(testCache.size()).toBe(5);
                    }
                });

                it('åº”è¯¥æä¾›æ­£ç¡®çš„ç»Ÿè®¡ä¿¡æ¯', () => {
                    if (testCache) {
                        testCache.set('stats-key', 'stats-value');
                        testCache.get('stats-key');
                        testCache.get('non-existent-key');
                        
                        const stats = testCache.getStats();
                        expect(stats.hits).toBe(1);
                        expect(stats.misses).toBe(1);
                    }
                });
            });
        }

        // æ€§èƒ½ä¼˜åŒ–æµ‹è¯•
        function definePerformanceTests() {
            describe('æ€§èƒ½ä¼˜åŒ–æµ‹è¯•', () => {
                it('åº”è¯¥èƒ½å¤Ÿåˆ›å»ºæ€§èƒ½ä¼˜åŒ–å™¨å®ä¾‹', () => {
                    if (typeof PerformanceOptimizer !== 'undefined') {
                        const optimizer = new PerformanceOptimizer();
                        expect(optimizer).toBeInstanceOf(PerformanceOptimizer);
                    }
                });

                it('é˜²æŠ–å‡½æ•°åº”è¯¥æ­£å¸¸å·¥ä½œ', async () => {
                    if (typeof window.debounce !== 'undefined') {
                        let callCount = 0;
                        const debouncedFn = window.debounce(() => callCount++, 100);
                        
                        debouncedFn();
                        debouncedFn();
                        debouncedFn();
                        
                        expect(callCount).toBe(0);
                        
                        await new Promise(resolve => setTimeout(resolve, 150));
                        expect(callCount).toBe(1);
                    }
                });

                it('èŠ‚æµå‡½æ•°åº”è¯¥æ­£å¸¸å·¥ä½œ', () => {
                    if (typeof window.throttle !== 'undefined') {
                        let callCount = 0;
                        const throttledFn = window.throttle(() => callCount++, 100);
                        
                        throttledFn();
                        throttledFn();
                        throttledFn();
                        
                        expect(callCount).toBe(1);
                    }
                });

                it('åº”è¯¥èƒ½å¤Ÿè¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•', () => {
                    if (window.performanceOptimizer) {
                        const result = window.performanceOptimizer.benchmark('test', () => {
                            return Math.random();
                        }, 10);
                        
                        expect(result).toHaveProperty('name');
                        expect(result).toHaveProperty('average');
                        expect(result.name).toBe('test');
                    }
                });
            });
        }

        // DOMæµ‹è¯•
        function defineDOMTests() {
            describe('DOMæ“ä½œæµ‹è¯•', () => {
                it('åº”è¯¥èƒ½å¤Ÿåˆ›å»ºæµ‹è¯•å…ƒç´ ', () => {
                    const element = createTestElement('div', { id: 'test-element' });
                    expect(element.tagName).toBe('DIV');
                    expect(element.id).toBe('test-element');
                    expect(document.getElementById('test-element')).toBe(element);
                });

                it('åº”è¯¥èƒ½å¤Ÿå¤„ç†äº‹ä»¶', () => {
                    const element = createTestElement('button');
                    let clicked = false;
                    
                    element.addEventListener('click', () => {
                        clicked = true;
                    });
                    
                    element.click();
                    expect(clicked).toBeTruthy();
                });
            });
        }

        // å¤±è´¥æµ‹è¯•ï¼ˆç”¨äºæµ‹è¯•æ¡†æ¶æœ¬èº«ï¼‰
        function defineFailureTests() {
            describe('å¤±è´¥æµ‹è¯•ç¤ºä¾‹', () => {
                it('è¿™ä¸ªæµ‹è¯•åº”è¯¥å¤±è´¥', () => {
                    expect(true).toBe(false);
                });

                it('è¿™ä¸ªæµ‹è¯•ä¼šæŠ›å‡ºé”™è¯¯', () => {
                    throw new Error('æ•…æ„æŠ›å‡ºçš„é”™è¯¯');
                });

                it('å¼‚æ­¥æµ‹è¯•å¤±è´¥', async () => {
                    await new Promise(resolve => setTimeout(resolve, 10));
                    expect(1).toBe(2);
                });
            });
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            clearResults();
            console.log('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•...');
            
            defineUtilsTests();
            defineCacheTests();
            definePerformanceTests();
            defineDOMTests();
            
            const results = await runTests();
            updateStats(results);
        }

        // è¿è¡Œå·¥å…·å‡½æ•°æµ‹è¯•
        async function runUtilsTests() {
            clearResults();
            console.log('ğŸ”§ è¿è¡Œå·¥å…·å‡½æ•°æµ‹è¯•...');
            
            defineUtilsTests();
            const results = await runTests();
            updateStats(results);
        }

        // è¿è¡Œç¼“å­˜æµ‹è¯•
        async function runCacheTests() {
            clearResults();
            console.log('ğŸ’¾ è¿è¡Œç¼“å­˜æµ‹è¯•...');
            
            defineCacheTests();
            const results = await runTests();
            updateStats(results);
        }

        // è¿è¡Œæ€§èƒ½æµ‹è¯•
        async function runPerformanceTests() {
            clearResults();
            console.log('âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•...');
            
            definePerformanceTests();
            const results = await runTests();
            updateStats(results);
        }

        // è¿è¡Œå¤±è´¥æµ‹è¯•
        async function runFailureTests() {
            clearResults();
            console.log('âŒ è¿è¡Œå¤±è´¥æµ‹è¯•ç¤ºä¾‹...');
            
            defineFailureTests();
            const results = await runTests();
            updateStats(results);
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(results) {
            document.getElementById('total-tests').textContent = results.total;
            document.getElementById('passed-tests').textContent = results.passed;
            document.getElementById('failed-tests').textContent = results.failed;
            document.getElementById('pass-rate').textContent = `${results.passRate}%`;
            
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = `${results.passRate}%`;
            
            if (results.passRate < 70) {
                progressFill.style.background = '#dc3545';
            } else if (results.passRate < 90) {
                progressFill.style.background = '#ffc107';
            } else {
                progressFill.style.background = '#28a745';
            }
            
            document.getElementById('stats-grid').style.display = 'grid';
            document.getElementById('progress-bar').style.display = 'block';
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            testOutput.textContent = '';
            document.getElementById('stats-grid').style.display = 'none';
            document.getElementById('progress-bar').style.display = 'none';
            
            // é‡ç½®æµ‹è¯•æ¡†æ¶
            if (window.testFramework) {
                window.testFramework.tests = [];
                window.testFramework.suites.clear();
                window.testFramework.results = {
                    passed: 0,
                    failed: 0,
                    skipped: 0,
                    total: 0
                };
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ§ª å•å…ƒæµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('ğŸ“‹ å¯ç”¨æµ‹è¯•å¥—ä»¶: å·¥å…·å‡½æ•°ã€ç¼“å­˜ç³»ç»Ÿã€æ€§èƒ½ä¼˜åŒ–ã€DOMæ“ä½œ');
        });
    </script>
</body>
</html>