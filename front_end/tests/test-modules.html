<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaPlot 模块测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .module-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .module-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .status-indicator.ready {
            background: #28a745;
        }
        
        .module-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .test-section {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .file-selector-container {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧪 DaPlot 模块化架构测试</h1>
            <p>这个页面用于测试新的模块化架构是否正常工作</p>
            <div id="global-status"></div>
        </div>

        <div class="module-grid">
            <!-- ConfigManager 测试 -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="config-status"></span>
                    ConfigManager
                </h3>
                <div class="module-info">配置管理模块</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testConfigManager()">测试配置</button>
                    <button class="btn btn-sm" onclick="showConfig()">显示配置</button>
                    <div id="config-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- EventBus 测试 -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="eventbus-status"></span>
                    EventBus
                </h3>
                <div class="module-info">事件总线模块</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testEventBus()">测试事件</button>
                    <button class="btn btn-sm" onclick="showEventStats()">事件统计</button>
                    <div id="eventbus-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- ApiClient 测试 -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="api-status"></span>
                    ApiClient
                </h3>
                <div class="module-info">API客户端模块</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testApiClient()">测试API</button>
                    <button class="btn btn-sm" onclick="testApiHealth()">健康检查</button>
                    <div id="api-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- AppState 测试 -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="state-status"></span>
                    AppState
                </h3>
                <div class="module-info">应用状态管理模块</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testAppState()">测试状态</button>
                    <button class="btn btn-sm" onclick="showAppState()">显示状态</button>
                    <div id="state-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- DataManager 测试 -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="data-status"></span>
                    DataManager
                </h3>
                <div class="module-info">数据管理模块</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testDataManager()">测试数据</button>
                    <button class="btn btn-sm" onclick="showDataCache()">缓存状态</button>
                    <div id="data-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- ChartEngine 测试 -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="chart-status"></span>
                    ChartEngine
                </h3>
                <div class="module-info">图表引擎模块</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testChartEngine()">测试图表</button>
                    <button class="btn btn-sm" onclick="loadPlotly()">加载Plotly</button>
                    <div id="chart-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- FileSelector 组件测试 -->
            <div class="module-card file-selector-container">
                <h3>
                    <span class="status-indicator" id="fileselector-status"></span>
                    FileSelector 组件
                </h3>
                <div class="module-info">文件选择器组件测试</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="initFileSelector()">初始化组件</button>
                    <button class="btn btn-sm" onclick="destroyFileSelector()">销毁组件</button>
                    <div id="file-selector-container" style="margin-top: 15px; min-height: 200px; border: 1px dashed #ccc; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载DaPlot模块 -->
    <script src="src/daplot.js"></script>

    <script>
        let fileSelector = null;

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 监听DaPlot初始化完成事件
            if (window.eventBus) {
                window.eventBus.on('daplot.initialized', function() {
                    updateModuleStatus();
                });
            }

            // 延迟更新状态，确保模块加载完成
            setTimeout(updateModuleStatus, 1000);
        });

        // 更新模块状态指示器
        function updateModuleStatus() {
            const modules = [
                { name: 'config', instance: window.configManager },
                { name: 'eventbus', instance: window.eventBus },
                { name: 'api', instance: window.apiClient },
                { name: 'state', instance: window.appState },
                { name: 'data', instance: window.dataManager },
                { name: 'chart', instance: window.chartEngine },
                { name: 'fileselector', instance: window.FileSelector }
            ];

            modules.forEach(module => {
                const indicator = document.getElementById(`${module.name}-status`);
                if (indicator) {
                    if (module.instance) {
                        indicator.classList.add('ready');
                        indicator.title = '模块已就绪';
                    } else {
                        indicator.classList.remove('ready');
                        indicator.title = '模块未就绪';
                    }
                }
            });

            // 更新全局状态
            const globalStatus = document.getElementById('global-status');
            if (window.DaPlot && window.DaPlot.isReady()) {
                globalStatus.innerHTML = '<span style="color: #28a745;">✅ 所有模块已就绪</span>';
            } else {
                globalStatus.innerHTML = '<span style="color: #dc3545;">⚠️ 部分模块未就绪</span>';
            }
        }

        // 测试函数
        function testConfigManager() {
            const output = document.getElementById('config-output');
            output.style.display = 'block';
            
            try {
                if (!window.configManager) {
                    throw new Error('ConfigManager 未初始化');
                }

                const config = window.configManager;
                const results = [];

                // 测试获取配置
                results.push(`API Base URL: ${config.get('api.baseUrl')}`);
                results.push(`UI Theme: ${config.get('ui.theme')}`);
                results.push(`Debug Mode: ${config.get('debug.enabled')}`);

                // 测试设置配置
                config.set('test.value', 'Hello World');
                results.push(`Test Value: ${config.get('test.value')}`);

                output.innerHTML = results.join('<br>');
            } catch (error) {
                output.innerHTML = `<span style="color: red;">错误: ${error.message}</span>`;
            }
        }

        function showConfig() {
            const output = document.getElementById('config-output');
            output.style.display = 'block';
            
            if (window.configManager) {
                output.innerHTML = `<pre>${JSON.stringify(window.configManager.config, null, 2)}</pre>`;
            } else {
                output.innerHTML = '<span style="color: red;">ConfigManager 未初始化</span>';
            }
        }

        function testEventBus() {
            const output = document.getElementById('eventbus-output');
            output.style.display = 'block';
            
            try {
                if (!window.eventBus) {
                    throw new Error('EventBus 未初始化');
                }

                const results = [];
                const eventBus = window.eventBus;

                // 订阅测试事件
                const unsubscribe = eventBus.on('test.event', (data) => {
                    results.push(`收到事件: ${JSON.stringify(data)}`);
                    output.innerHTML = results.join('<br>');
                });

                // 发送测试事件
                eventBus.emit('test.event', { message: 'Hello EventBus!', timestamp: new Date().toISOString() });

                results.push('事件测试完成');
                setTimeout(() => unsubscribe(), 1000);

            } catch (error) {
                output.innerHTML = `<span style="color: red;">错误: ${error.message}</span>`;
            }
        }

        function showEventStats() {
            const output = document.getElementById('eventbus-output');
            output.style.display = 'block';
            
            if (window.eventBus) {
                const stats = window.eventBus.getStats();
                output.innerHTML = `<pre>${JSON.stringify(stats, null, 2)}</pre>`;
            } else {
                output.innerHTML = '<span style="color: red;">EventBus 未初始化</span>';
            }
        }

        function testApiClient() {
            const output = document.getElementById('api-output');
            output.style.display = 'block';
            output.innerHTML = '正在测试API连接...';
            
            if (!window.apiClient) {
                output.innerHTML = '<span style="color: red;">ApiClient 未初始化</span>';
                return;
            }

            window.apiClient.get('/')
                .then(response => {
                    output.innerHTML = `<span style="color: green;">API连接成功</span><br><pre>${JSON.stringify(response.data, null, 2)}</pre>`;
                })
                .catch(error => {
                    output.innerHTML = `<span style="color: red;">API连接失败: ${error.message}</span>`;
                });
        }

        function testApiHealth() {
            const output = document.getElementById('api-output');
            output.style.display = 'block';
            output.innerHTML = '正在检查API健康状态...';
            
            if (!window.apiClient) {
                output.innerHTML = '<span style="color: red;">ApiClient 未初始化</span>';
                return;
            }

            window.apiClient.get('/docs')
                .then(response => {
                    output.innerHTML = `<span style="color: green;">API健康检查通过</span><br>状态码: ${response.status}`;
                })
                .catch(error => {
                    output.innerHTML = `<span style="color: orange;">API可能未启动: ${error.message}</span>`;
                });
        }

        function testAppState() {
            const output = document.getElementById('state-output');
            output.style.display = 'block';
            
            try {
                if (!window.appState) {
                    throw new Error('AppState 未初始化');
                }

                const results = [];
                const appState = window.appState;

                // 订阅状态变更
                const unsubscribe = appState.subscribe('testValue', (newValue, oldValue) => {
                    results.push(`状态变更: ${oldValue} -> ${newValue}`);
                    output.innerHTML = results.join('<br>');
                });

                // 测试状态设置
                appState.setState({ testValue: 'Hello AppState!' });
                results.push(`当前状态: ${appState.getState('testValue')}`);

                setTimeout(() => unsubscribe(), 1000);

            } catch (error) {
                output.innerHTML = `<span style="color: red;">错误: ${error.message}</span>`;
            }
        }

        function showAppState() {
            const output = document.getElementById('state-output');
            output.style.display = 'block';
            
            if (window.appState) {
                const state = window.appState.getState();
                output.innerHTML = `<pre>${JSON.stringify(state, null, 2)}</pre>`;
            } else {
                output.innerHTML = '<span style="color: red;">AppState 未初始化</span>';
            }
        }

        function testDataManager() {
            const output = document.getElementById('data-output');
            output.style.display = 'block';
            output.innerHTML = '正在测试数据管理...';
            
            if (!window.dataManager) {
                output.innerHTML = '<span style="color: red;">DataManager 未初始化</span>';
                return;
            }

            window.dataManager.getFileList()
                .then(fileList => {
                    output.innerHTML = `<span style="color: green;">文件列表获取成功</span><br>文件数量: ${fileList.length}`;
                })
                .catch(error => {
                    output.innerHTML = `<span style="color: orange;">文件列表获取失败: ${error.message}</span>`;
                });
        }

        function showDataCache() {
            const output = document.getElementById('data-output');
            output.style.display = 'block';
            
            if (window.dataManager) {
                const cacheSize = window.dataManager.cache.size;
                output.innerHTML = `缓存项数量: ${cacheSize}`;
            } else {
                output.innerHTML = '<span style="color: red;">DataManager 未初始化</span>';
            }
        }

        function testChartEngine() {
            const output = document.getElementById('chart-output');
            output.style.display = 'block';
            output.innerHTML = '正在测试图表引擎...';
            
            if (!window.chartEngine) {
                output.innerHTML = '<span style="color: red;">ChartEngine 未初始化</span>';
                return;
            }

            output.innerHTML = `图表引擎已初始化<br>Plotly状态: ${window.chartEngine.plotlyLoaded ? '已加载' : '未加载'}`;
        }

        function loadPlotly() {
            const output = document.getElementById('chart-output');
            output.style.display = 'block';
            output.innerHTML = '正在加载Plotly...';
            
            if (!window.chartEngine) {
                output.innerHTML = '<span style="color: red;">ChartEngine 未初始化</span>';
                return;
            }

            window.chartEngine.ensurePlotlyLoaded()
                .then(() => {
                    output.innerHTML = '<span style="color: green;">Plotly加载成功</span>';
                })
                .catch(error => {
                    output.innerHTML = `<span style="color: red;">Plotly加载失败: ${error.message}</span>`;
                });
        }

        function initFileSelector() {
            if (fileSelector) {
                fileSelector.destroy();
            }

            try {
                fileSelector = new FileSelector({
                    container: 'file-selector-container',
                    showUpload: true,
                    showActions: true,
                    onSelect: (file) => {
                        console.log('文件选中:', file);
                    },
                    onUpload: (result) => {
                        console.log('文件上传:', result);
                    }
                });

                document.getElementById('fileselector-status').classList.add('ready');
            } catch (error) {
                console.error('FileSelector初始化失败:', error);
            }
        }

        function destroyFileSelector() {
            if (fileSelector) {
                fileSelector.destroy();
                fileSelector = null;
                document.getElementById('fileselector-status').classList.remove('ready');
            }
        }
    </script>
</body>
</html>