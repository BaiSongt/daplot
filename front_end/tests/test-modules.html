<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaPlot æ¨¡å—æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .module-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .module-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .status-indicator.ready {
            background: #28a745;
        }
        
        .module-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .test-section {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .file-selector-container {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª DaPlot æ¨¡å—åŒ–æ¶æ„æµ‹è¯•</h1>
            <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•æ–°çš„æ¨¡å—åŒ–æ¶æ„æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
            <div id="global-status"></div>
        </div>

        <div class="module-grid">
            <!-- ConfigManager æµ‹è¯• -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="config-status"></span>
                    ConfigManager
                </h3>
                <div class="module-info">é…ç½®ç®¡ç†æ¨¡å—</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testConfigManager()">æµ‹è¯•é…ç½®</button>
                    <button class="btn btn-sm" onclick="showConfig()">æ˜¾ç¤ºé…ç½®</button>
                    <div id="config-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- EventBus æµ‹è¯• -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="eventbus-status"></span>
                    EventBus
                </h3>
                <div class="module-info">äº‹ä»¶æ€»çº¿æ¨¡å—</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testEventBus()">æµ‹è¯•äº‹ä»¶</button>
                    <button class="btn btn-sm" onclick="showEventStats()">äº‹ä»¶ç»Ÿè®¡</button>
                    <div id="eventbus-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- ApiClient æµ‹è¯• -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="api-status"></span>
                    ApiClient
                </h3>
                <div class="module-info">APIå®¢æˆ·ç«¯æ¨¡å—</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testApiClient()">æµ‹è¯•API</button>
                    <button class="btn btn-sm" onclick="testApiHealth()">å¥åº·æ£€æŸ¥</button>
                    <div id="api-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- AppState æµ‹è¯• -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="state-status"></span>
                    AppState
                </h3>
                <div class="module-info">åº”ç”¨çŠ¶æ€ç®¡ç†æ¨¡å—</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testAppState()">æµ‹è¯•çŠ¶æ€</button>
                    <button class="btn btn-sm" onclick="showAppState()">æ˜¾ç¤ºçŠ¶æ€</button>
                    <div id="state-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- DataManager æµ‹è¯• -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="data-status"></span>
                    DataManager
                </h3>
                <div class="module-info">æ•°æ®ç®¡ç†æ¨¡å—</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testDataManager()">æµ‹è¯•æ•°æ®</button>
                    <button class="btn btn-sm" onclick="showDataCache()">ç¼“å­˜çŠ¶æ€</button>
                    <div id="data-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- ChartEngine æµ‹è¯• -->
            <div class="module-card">
                <h3>
                    <span class="status-indicator" id="chart-status"></span>
                    ChartEngine
                </h3>
                <div class="module-info">å›¾è¡¨å¼•æ“æ¨¡å—</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="testChartEngine()">æµ‹è¯•å›¾è¡¨</button>
                    <button class="btn btn-sm" onclick="loadPlotly()">åŠ è½½Plotly</button>
                    <div id="chart-output" class="log-output" style="display: none;"></div>
                </div>
            </div>

            <!-- FileSelector ç»„ä»¶æµ‹è¯• -->
            <div class="module-card file-selector-container">
                <h3>
                    <span class="status-indicator" id="fileselector-status"></span>
                    FileSelector ç»„ä»¶
                </h3>
                <div class="module-info">æ–‡ä»¶é€‰æ‹©å™¨ç»„ä»¶æµ‹è¯•</div>
                <div class="test-section">
                    <button class="btn btn-sm" onclick="initFileSelector()">åˆå§‹åŒ–ç»„ä»¶</button>
                    <button class="btn btn-sm" onclick="destroyFileSelector()">é”€æ¯ç»„ä»¶</button>
                    <div id="file-selector-container" style="margin-top: 15px; min-height: 200px; border: 1px dashed #ccc; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½DaPlotæ¨¡å— -->
    <script src="src/daplot.js"></script>

    <script>
        let fileSelector = null;

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç›‘å¬DaPlotåˆå§‹åŒ–å®Œæˆäº‹ä»¶
            if (window.eventBus) {
                window.eventBus.on('daplot.initialized', function() {
                    updateModuleStatus();
                });
            }

            // å»¶è¿Ÿæ›´æ–°çŠ¶æ€ï¼Œç¡®ä¿æ¨¡å—åŠ è½½å®Œæˆ
            setTimeout(updateModuleStatus, 1000);
        });

        // æ›´æ–°æ¨¡å—çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateModuleStatus() {
            const modules = [
                { name: 'config', instance: window.configManager },
                { name: 'eventbus', instance: window.eventBus },
                { name: 'api', instance: window.apiClient },
                { name: 'state', instance: window.appState },
                { name: 'data', instance: window.dataManager },
                { name: 'chart', instance: window.chartEngine },
                { name: 'fileselector', instance: window.FileSelector }
            ];

            modules.forEach(module => {
                const indicator = document.getElementById(`${module.name}-status`);
                if (indicator) {
                    if (module.instance) {
                        indicator.classList.add('ready');
                        indicator.title = 'æ¨¡å—å·²å°±ç»ª';
                    } else {
                        indicator.classList.remove('ready');
                        indicator.title = 'æ¨¡å—æœªå°±ç»ª';
                    }
                }
            });

            // æ›´æ–°å…¨å±€çŠ¶æ€
            const globalStatus = document.getElementById('global-status');
            if (window.DaPlot && window.DaPlot.isReady()) {
                globalStatus.innerHTML = '<span style="color: #28a745;">âœ… æ‰€æœ‰æ¨¡å—å·²å°±ç»ª</span>';
            } else {
                globalStatus.innerHTML = '<span style="color: #dc3545;">âš ï¸ éƒ¨åˆ†æ¨¡å—æœªå°±ç»ª</span>';
            }
        }

        // æµ‹è¯•å‡½æ•°
        function testConfigManager() {
            const output = document.getElementById('config-output');
            output.style.display = 'block';
            
            try {
                if (!window.configManager) {
                    throw new Error('ConfigManager æœªåˆå§‹åŒ–');
                }

                const config = window.configManager;
                const results = [];

                // æµ‹è¯•è·å–é…ç½®
                results.push(`API Base URL: ${config.get('api.baseUrl')}`);
                results.push(`UI Theme: ${config.get('ui.theme')}`);
                results.push(`Debug Mode: ${config.get('debug.enabled')}`);

                // æµ‹è¯•è®¾ç½®é…ç½®
                config.set('test.value', 'Hello World');
                results.push(`Test Value: ${config.get('test.value')}`);

                output.innerHTML = results.join('<br>');
            } catch (error) {
                output.innerHTML = `<span style="color: red;">é”™è¯¯: ${error.message}</span>`;
            }
        }

        function showConfig() {
            const output = document.getElementById('config-output');
            output.style.display = 'block';
            
            if (window.configManager) {
                output.innerHTML = `<pre>${JSON.stringify(window.configManager.config, null, 2)}</pre>`;
            } else {
                output.innerHTML = '<span style="color: red;">ConfigManager æœªåˆå§‹åŒ–</span>';
            }
        }

        function testEventBus() {
            const output = document.getElementById('eventbus-output');
            output.style.display = 'block';
            
            try {
                if (!window.eventBus) {
                    throw new Error('EventBus æœªåˆå§‹åŒ–');
                }

                const results = [];
                const eventBus = window.eventBus;

                // è®¢é˜…æµ‹è¯•äº‹ä»¶
                const unsubscribe = eventBus.on('test.event', (data) => {
                    results.push(`æ”¶åˆ°äº‹ä»¶: ${JSON.stringify(data)}`);
                    output.innerHTML = results.join('<br>');
                });

                // å‘é€æµ‹è¯•äº‹ä»¶
                eventBus.emit('test.event', { message: 'Hello EventBus!', timestamp: new Date().toISOString() });

                results.push('äº‹ä»¶æµ‹è¯•å®Œæˆ');
                setTimeout(() => unsubscribe(), 1000);

            } catch (error) {
                output.innerHTML = `<span style="color: red;">é”™è¯¯: ${error.message}</span>`;
            }
        }

        function showEventStats() {
            const output = document.getElementById('eventbus-output');
            output.style.display = 'block';
            
            if (window.eventBus) {
                const stats = window.eventBus.getStats();
                output.innerHTML = `<pre>${JSON.stringify(stats, null, 2)}</pre>`;
            } else {
                output.innerHTML = '<span style="color: red;">EventBus æœªåˆå§‹åŒ–</span>';
            }
        }

        function testApiClient() {
            const output = document.getElementById('api-output');
            output.style.display = 'block';
            output.innerHTML = 'æ­£åœ¨æµ‹è¯•APIè¿æ¥...';
            
            if (!window.apiClient) {
                output.innerHTML = '<span style="color: red;">ApiClient æœªåˆå§‹åŒ–</span>';
                return;
            }

            window.apiClient.get('/')
                .then(response => {
                    output.innerHTML = `<span style="color: green;">APIè¿æ¥æˆåŠŸ</span><br><pre>${JSON.stringify(response.data, null, 2)}</pre>`;
                })
                .catch(error => {
                    output.innerHTML = `<span style="color: red;">APIè¿æ¥å¤±è´¥: ${error.message}</span>`;
                });
        }

        function testApiHealth() {
            const output = document.getElementById('api-output');
            output.style.display = 'block';
            output.innerHTML = 'æ­£åœ¨æ£€æŸ¥APIå¥åº·çŠ¶æ€...';
            
            if (!window.apiClient) {
                output.innerHTML = '<span style="color: red;">ApiClient æœªåˆå§‹åŒ–</span>';
                return;
            }

            window.apiClient.get('/docs')
                .then(response => {
                    output.innerHTML = `<span style="color: green;">APIå¥åº·æ£€æŸ¥é€šè¿‡</span><br>çŠ¶æ€ç : ${response.status}`;
                })
                .catch(error => {
                    output.innerHTML = `<span style="color: orange;">APIå¯èƒ½æœªå¯åŠ¨: ${error.message}</span>`;
                });
        }

        function testAppState() {
            const output = document.getElementById('state-output');
            output.style.display = 'block';
            
            try {
                if (!window.appState) {
                    throw new Error('AppState æœªåˆå§‹åŒ–');
                }

                const results = [];
                const appState = window.appState;

                // è®¢é˜…çŠ¶æ€å˜æ›´
                const unsubscribe = appState.subscribe('testValue', (newValue, oldValue) => {
                    results.push(`çŠ¶æ€å˜æ›´: ${oldValue} -> ${newValue}`);
                    output.innerHTML = results.join('<br>');
                });

                // æµ‹è¯•çŠ¶æ€è®¾ç½®
                appState.setState({ testValue: 'Hello AppState!' });
                results.push(`å½“å‰çŠ¶æ€: ${appState.getState('testValue')}`);

                setTimeout(() => unsubscribe(), 1000);

            } catch (error) {
                output.innerHTML = `<span style="color: red;">é”™è¯¯: ${error.message}</span>`;
            }
        }

        function showAppState() {
            const output = document.getElementById('state-output');
            output.style.display = 'block';
            
            if (window.appState) {
                const state = window.appState.getState();
                output.innerHTML = `<pre>${JSON.stringify(state, null, 2)}</pre>`;
            } else {
                output.innerHTML = '<span style="color: red;">AppState æœªåˆå§‹åŒ–</span>';
            }
        }

        function testDataManager() {
            const output = document.getElementById('data-output');
            output.style.display = 'block';
            output.innerHTML = 'æ­£åœ¨æµ‹è¯•æ•°æ®ç®¡ç†...';
            
            if (!window.dataManager) {
                output.innerHTML = '<span style="color: red;">DataManager æœªåˆå§‹åŒ–</span>';
                return;
            }

            window.dataManager.getFileList()
                .then(fileList => {
                    output.innerHTML = `<span style="color: green;">æ–‡ä»¶åˆ—è¡¨è·å–æˆåŠŸ</span><br>æ–‡ä»¶æ•°é‡: ${fileList.length}`;
                })
                .catch(error => {
                    output.innerHTML = `<span style="color: orange;">æ–‡ä»¶åˆ—è¡¨è·å–å¤±è´¥: ${error.message}</span>`;
                });
        }

        function showDataCache() {
            const output = document.getElementById('data-output');
            output.style.display = 'block';
            
            if (window.dataManager) {
                const cacheSize = window.dataManager.cache.size;
                output.innerHTML = `ç¼“å­˜é¡¹æ•°é‡: ${cacheSize}`;
            } else {
                output.innerHTML = '<span style="color: red;">DataManager æœªåˆå§‹åŒ–</span>';
            }
        }

        function testChartEngine() {
            const output = document.getElementById('chart-output');
            output.style.display = 'block';
            output.innerHTML = 'æ­£åœ¨æµ‹è¯•å›¾è¡¨å¼•æ“...';
            
            if (!window.chartEngine) {
                output.innerHTML = '<span style="color: red;">ChartEngine æœªåˆå§‹åŒ–</span>';
                return;
            }

            output.innerHTML = `å›¾è¡¨å¼•æ“å·²åˆå§‹åŒ–<br>PlotlyçŠ¶æ€: ${window.chartEngine.plotlyLoaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}`;
        }

        function loadPlotly() {
            const output = document.getElementById('chart-output');
            output.style.display = 'block';
            output.innerHTML = 'æ­£åœ¨åŠ è½½Plotly...';
            
            if (!window.chartEngine) {
                output.innerHTML = '<span style="color: red;">ChartEngine æœªåˆå§‹åŒ–</span>';
                return;
            }

            window.chartEngine.ensurePlotlyLoaded()
                .then(() => {
                    output.innerHTML = '<span style="color: green;">PlotlyåŠ è½½æˆåŠŸ</span>';
                })
                .catch(error => {
                    output.innerHTML = `<span style="color: red;">PlotlyåŠ è½½å¤±è´¥: ${error.message}</span>`;
                });
        }

        function initFileSelector() {
            if (fileSelector) {
                fileSelector.destroy();
            }

            try {
                fileSelector = new FileSelector({
                    container: 'file-selector-container',
                    showUpload: true,
                    showActions: true,
                    onSelect: (file) => {
                        console.log('æ–‡ä»¶é€‰ä¸­:', file);
                    },
                    onUpload: (result) => {
                        console.log('æ–‡ä»¶ä¸Šä¼ :', result);
                    }
                });

                document.getElementById('fileselector-status').classList.add('ready');
            } catch (error) {
                console.error('FileSelectoråˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        function destroyFileSelector() {
            if (fileSelector) {
                fileSelector.destroy();
                fileSelector = null;
                document.getElementById('fileselector-status').classList.remove('ready');
            }
        }
    </script>
</body>
</html>