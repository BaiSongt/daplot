/**
 * Êñá‰ª∂ÈÄâÊã©Âô®ÁªÑ‰ª∂
 * Êèê‰æõÊñá‰ª∂ÂàóË°®ÊòæÁ§∫„ÄÅÈÄâÊã©„ÄÅÊìç‰ΩúÁ≠âÂäüËÉΩ
 */
class FileSelector {
    constructor(options = {}) {
        this.options = {
            container: null,
            multiple: false,
            showActions: true,
            showUpload: true,
            showPreview: true,
            allowedTypes: ['application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'],
            maxFileSize: 50 * 1024 * 1024, // 50MB
            onSelect: null,
            onDelete: null,
            onUpload: null,
            onRefresh: null,
            ...options
        };

        this.container = null;
        this.fileList = [];
        this.selectedFileId = null;
        this.isLoading = false;

        this.init();
    }

    // ÂàùÂßãÂåñÁªÑ‰ª∂
    init() {
        if (typeof this.options.container === 'string') {
            this.container = document.getElementById(this.options.container);
        } else if (this.options.container instanceof HTMLElement) {
            this.container = this.options.container;
        }

        if (!this.container) {
            throw new Error('FileSelector: ÂÆπÂô®ÂÖÉÁ¥†Êú™ÊâæÂà∞');
        }

        this.render();
        this.bindEvents();
        this.loadFileList();
    }

    // Ê∏≤ÊüìÁªÑ‰ª∂
    render() {
        this.container.innerHTML = `
            <div class="file-selector">
                <div class="file-selector-header">
                    <h3>üìÅ Êñá‰ª∂ÁÆ°ÁêÜ</h3>
                    <div class="file-selector-actions">
                        ${this.options.showUpload ? `
                            <input type="file" id="fileInput-${this.generateId()}" 
                                   accept="${this.options.allowedTypes.join(',')}" 
                                   style="display: none;" 
                                   ${this.options.multiple ? 'multiple' : ''}>
                            <button class="btn btn-primary btn-upload">
                                üìÅ ‰∏ä‰º†Êñá‰ª∂
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary btn-refresh">
                            üîÑ Âà∑Êñ∞
                        </button>
                    </div>
                </div>
                
                <div class="file-selector-status" style="display: none;">
                    <div class="status-message"></div>
                </div>
                
                <div class="file-selector-content">
                    <div class="file-list">
                        <div class="file-list-loading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <span>Ê≠£Âú®Âä†ËΩΩÊñá‰ª∂ÂàóË°®...</span>
                        </div>
                        <div class="file-list-empty" style="display: none;">
                            <div class="empty-icon">üìÑ</div>
                            <p>ÊöÇÊó†Êñá‰ª∂</p>
                            ${this.options.showUpload ? '<p>ÁÇπÂáª‰∏ä‰º†ÊåâÈíÆÊ∑ªÂä†Êñá‰ª∂</p>' : ''}
                        </div>
                        <div class="file-list-items"></div>
                    </div>
                </div>
                
                ${this.options.showPreview ? `
                    <div class="file-preview-container" style="display: none;">
                        <h4>Êñá‰ª∂È¢ÑËßà</h4>
                        <div id="file-preview"></div>
                    </div>
                ` : ''}
            </div>
        `;

        this.addStyles();
    }

    // Ê∑ªÂä†Ê†∑Âºè
    addStyles() {
        if (document.getElementById('file-selector-styles')) return;

        const style = document.createElement('style');
        style.id = 'file-selector-styles';
        style.textContent = `
            .file-selector {
                background: white;
                border-radius: 8px;
                border: 1px solid #e9ecef;
                overflow: hidden;
            }
            
            .file-selector-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: #f8f9fa;
                border-bottom: 1px solid #e9ecef;
            }
            
            .file-selector-header h3 {
                margin: 0;
                font-size: 14px;
                color: #495057;
            }
            
            .file-selector-actions {
                display: flex;
                gap: 8px;
            }
            
            .file-selector .btn {
                padding: 6px 12px;
                font-size: 12px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .file-selector .btn-primary {
                background: #007bff;
                color: white;
            }
            
            .file-selector .btn-primary:hover {
                background: #0056b3;
            }
            
            .file-selector .btn-secondary {
                background: #6c757d;
                color: white;
            }
            
            .file-selector .btn-secondary:hover {
                background: #545b62;
            }
            
            .file-selector .btn-danger {
                background: #dc3545;
                color: white;
            }
            
            .file-selector .btn-danger:hover {
                background: #c82333;
            }
            
            .file-selector-status {
                padding: 10px 15px;
                border-bottom: 1px solid #e9ecef;
            }
            
            .status-message {
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
            }
            
            .status-message.success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            
            .status-message.error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            
            .status-message.info {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }
            
            .file-selector-content {
                max-height: 400px;
                overflow-y: auto;
            }
            
            .file-list-loading,
            .file-list-empty {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px 20px;
                color: #6c757d;
                text-align: center;
            }
            
            .loading-spinner {
                width: 24px;
                height: 24px;
                border: 2px solid #e9ecef;
                border-top: 2px solid #007bff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 10px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .empty-icon {
                font-size: 48px;
                margin-bottom: 15px;
                opacity: 0.5;
            }
            
            .file-item {
                display: flex;
                align-items: center;
                padding: 12px 15px;
                border-bottom: 1px solid #f8f9fa;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .file-item:hover {
                background: #f8f9fa;
            }
            
            .file-item.selected {
                background: #e3f2fd;
                border-left: 3px solid #007bff;
            }
            
            .file-item:last-child {
                border-bottom: none;
            }
            
            .file-icon {
                font-size: 20px;
                margin-right: 12px;
                color: #007bff;
            }
            
            .file-info {
                flex: 1;
                min-width: 0;
            }
            
            .file-name {
                font-weight: 500;
                color: #333;
                margin-bottom: 2px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 13px;
            }
            
            .file-meta {
                font-size: 11px;
                color: #6c757d;
                display: flex;
                gap: 10px;
            }
            
            .file-actions {
                display: flex;
                gap: 5px;
                opacity: 0;
                transition: opacity 0.2s;
            }
            
            .file-item:hover .file-actions {
                opacity: 1;
            }
            
            .file-actions .btn {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .file-preview-container {
                padding: 15px;
                border-top: 1px solid #e9ecef;
                background: #f8f9fa;
            }
            
            .file-preview-container h4 {
                margin: 0 0 10px 0;
                font-size: 14px;
                color: #495057;
            }
            
            .preview-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 12px;
            }
            
            .preview-table th,
            .preview-table td {
                padding: 8px;
                text-align: left;
                border: 1px solid #dee2e6;
            }
            
            .preview-table th {
                background: #e9ecef;
                font-weight: 500;
            }
            
            .preview-info {
                margin-top: 10px;
                font-size: 11px;
                color: #6c757d;
            }
            
            .loading, .error {
                padding: 20px;
                text-align: center;
                color: #6c757d;
            }
            
            .error {
                color: #dc3545;
            }
        `;
        
        document.head.appendChild(style);
    }

    // ÁªëÂÆö‰∫ã‰ª∂
    bindEvents() {
        const uploadBtn = this.container.querySelector('.btn-upload');
        const refreshBtn = this.container.querySelector('.btn-refresh');
        const fileInput = this.container.querySelector('input[type="file"]');

        if (uploadBtn && fileInput) {
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                this.handleFileUpload(e.target.files);
            });
        }

        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                this.refresh();
            });
        }

        // ÊãñÊãΩ‰∏ä‰º†
        if (this.options.showUpload) {
            this.container.addEventListener('dragover', (e) => {
                e.preventDefault();
                this.container.classList.add('drag-over');
            });

            this.container.addEventListener('dragleave', (e) => {
                e.preventDefault();
                this.container.classList.remove('drag-over');
            });

            this.container.addEventListener('drop', (e) => {
                e.preventDefault();
                this.container.classList.remove('drag-over');
                this.handleFileUpload(e.dataTransfer.files);
            });
        }
    }

    // ÁîüÊàêÂîØ‰∏ÄID
    generateId() {
        return Math.random().toString(36).substr(2, 9);
    }

    // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
    showStatus(message, type = 'info') {
        const statusContainer = this.container.querySelector('.file-selector-status');
        const statusMessage = this.container.querySelector('.status-message');

        statusMessage.textContent = message;
        statusMessage.className = `status-message ${type}`;
        statusContainer.style.display = 'block';

        // 3ÁßíÂêéËá™Âä®ÈöêËóè
        setTimeout(() => {
            statusContainer.style.display = 'none';
        }, 3000);
    }

    // ËÆæÁΩÆÂä†ËΩΩÁä∂ÊÄÅ
    setLoading(loading) {
        this.isLoading = loading;
        const loadingEl = this.container.querySelector('.file-list-loading');
        const itemsEl = this.container.querySelector('.file-list-items');
        const emptyEl = this.container.querySelector('.file-list-empty');

        if (loading) {
            loadingEl.style.display = 'flex';
            itemsEl.style.display = 'none';
            emptyEl.style.display = 'none';
        } else {
            loadingEl.style.display = 'none';
            if (this.fileList.length === 0) {
                emptyEl.style.display = 'flex';
                itemsEl.style.display = 'none';
            } else {
                emptyEl.style.display = 'none';
                itemsEl.style.display = 'block';
            }
        }
    }

    // Âä†ËΩΩÊñá‰ª∂ÂàóË°®
    async loadFileList() {
        this.setLoading(true);

        try {
            // Try to get file list from dataManager, fallback to mock data for testing
            let fileList;
            if (window.dataManager && typeof window.dataManager.getFileList === 'function') {
                fileList = await window.dataManager.getFileList();
            } else {
                // Mock data for testing
                await new Promise(resolve => setTimeout(resolve, 500));
                fileList = [
                    {
                        file_id: 'file1',
                        filename: 'sales_data.xlsx',
                        rows: 1000,
                        columns: 5
                    },
                    {
                        file_id: 'file2',
                        filename: 'customer_info.csv',
                        rows: 500,
                        columns: 8
                    },
                    {
                        file_id: 'file3',
                        filename: 'product_catalog.xlsx',
                        rows: 2000,
                        columns: 12
                    }
                ];
            }
            
            this.fileList = fileList;
            this.renderFileList();
        } catch (error) {
            console.error('Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•:', error);
            this.showStatus('Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•: ' + error.message, 'error');
        } finally {
            this.setLoading(false);
        }
    }

    // Ê∏≤ÊüìÊñá‰ª∂ÂàóË°®
    renderFileList() {
        const itemsContainer = this.container.querySelector('.file-list-items');
        
        if (this.fileList.length === 0) {
            itemsContainer.innerHTML = '';
            return;
        }

        itemsContainer.innerHTML = this.fileList.map(file => `
            <div class="file-item ${file.file_id === this.selectedFileId ? 'selected' : ''}" 
                 data-file-id="${file.file_id}">
                <div class="file-icon">üìä</div>
                <div class="file-info">
                    <div class="file-name" title="${file.filename}">${file.filename}</div>
                    <div class="file-meta">
                        <span>${file.rows || 0} Ë°å</span>
                        <span>${file.columns || 0} Âàó</span>
                        ${file.sheet_name ? `<span>${file.sheet_name}</span>` : ''}
                    </div>
                </div>
                ${this.options.showActions ? `
                    <div class="file-actions">
                        ${this.options.showPreview ? `
                            <button class="btn btn-secondary preview-btn" data-file-id="${file.file_id}">
                                üëÅÔ∏è
                            </button>
                        ` : ''}
                        <button class="btn btn-danger btn-delete" data-file-id="${file.file_id}">
                            üóëÔ∏è
                        </button>
                    </div>
                ` : ''}
            </div>
        `).join('');

        // ÁªëÂÆöÊñá‰ª∂È°π‰∫ã‰ª∂
        this.bindFileItemEvents();
    }

    // ÁªëÂÆöÊñá‰ª∂È°π‰∫ã‰ª∂
    bindFileItemEvents() {
        const fileItems = this.container.querySelectorAll('.file-item');
        const deleteButtons = this.container.querySelectorAll('.btn-delete');
        const previewButtons = this.container.querySelectorAll('.preview-btn');

        fileItems.forEach(item => {
            item.addEventListener('click', (e) => {
                if (e.target.closest('.file-actions')) return;
                
                const fileId = item.dataset.fileId;
                this.selectFile(fileId);
            });
        });

        deleteButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const fileId = btn.dataset.fileId;
                this.deleteFile(fileId);
            });
        });

        previewButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const fileId = btn.dataset.fileId;
                this.previewFile(fileId);
            });
        });
    }

    // ÈÄâÊã©Êñá‰ª∂
    selectFile(fileId) {
        const previousSelected = this.container.querySelector('.file-item.selected');
        if (previousSelected) {
            previousSelected.classList.remove('selected');
        }

        const selectedItem = this.container.querySelector(`[data-file-id="${fileId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('selected');
        }

        this.selectedFileId = fileId;

        // Ëß¶ÂèëÈÄâÊã©‰∫ã‰ª∂
        if (this.options.onSelect) {
            const file = this.fileList.find(f => f.file_id === fileId);
            this.options.onSelect(file, fileId);
        }

        // ÂèëÈÄÅ‰∫ã‰ª∂
        window.eventBus?.emit('file.selected', { fileId, file: this.fileList.find(f => f.file_id === fileId) });
    }

    // È¢ÑËßàÊñá‰ª∂
    async previewFile(fileId) {
        if (!this.options.showPreview) return;
        
        const file = this.fileList.find(f => f.file_id === fileId);
        if (!file) return;
        
        const previewContainer = this.container.querySelector('.file-preview-container');
        const previewContent = this.container.querySelector('#file-preview');
        
        previewContainer.style.display = 'block';
        previewContent.innerHTML = '<div class="loading">Âä†ËΩΩÈ¢ÑËßà‰∏≠...</div>';
        
        try {
            // Ê®°ÊãüËé∑ÂèñÈ¢ÑËßàÊï∞ÊçÆ
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const previewData = {
                headers: ['Êó•Êúü', 'ÈîÄÂîÆÈ¢ù', 'Âú∞Âå∫', '‰∫ßÂìÅ', 'Êï∞Èáè'],
                rows: [
                    ['2023-01-01', '10000', 'Âåó‰∫¨', '‰∫ßÂìÅA', '100'],
                    ['2023-01-02', '15000', '‰∏äÊµ∑', '‰∫ßÂìÅB', '150'],
                    ['2023-01-03', '12000', 'ÂπøÂ∑û', '‰∫ßÂìÅA', '120']
                ]
            };
            
            previewContent.innerHTML = `
                <table class="preview-table">
                    <thead>
                        <tr>
                            ${previewData.headers.map(header => `<th>${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${previewData.rows.map(row => `
                            <tr>
                                ${row.map(cell => `<td>${cell}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="preview-info">
                    <p>ÊòæÁ§∫Ââç3Ë°åÊï∞ÊçÆÔºåÂÖ± ${file.rows || 0} Ë°å √ó ${file.columns || 0} Âàó</p>
                </div>
            `;
        } catch (error) {
            previewContent.innerHTML = `<div class="error">È¢ÑËßàÂ§±Ë¥•: ${error.message}</div>`;
        }
    }

    // Âà†Èô§Êñá‰ª∂
    async deleteFile(fileId) {
        if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êñá‰ª∂ÂêóÔºü')) {
            return;
        }

        try {
            // Ë∞ÉÁî®Âà†Èô§API
            await window.apiClient.delete(`/api/file/${fileId}`);
            
            // ‰ªéÂàóË°®‰∏≠ÁßªÈô§
            this.fileList = this.fileList.filter(f => f.file_id !== fileId);
            
            // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑÊñá‰ª∂ÔºåÊ∏ÖÈô§ÈÄâÊã©
            if (this.selectedFileId === fileId) {
                this.selectedFileId = null;
            }
            
            // ÈáçÊñ∞Ê∏≤Êüì
            this.renderFileList();
            this.showStatus('Êñá‰ª∂Âà†Èô§ÊàêÂäü', 'success');

            // Ëß¶ÂèëÂà†Èô§‰∫ã‰ª∂
            if (this.options.onDelete) {
                this.options.onDelete(fileId);
            }

            // ÂèëÈÄÅ‰∫ã‰ª∂
            window.eventBus?.emit('file.deleted', { fileId });

        } catch (error) {
            console.error('Âà†Èô§Êñá‰ª∂Â§±Ë¥•:', error);
            this.showStatus('Âà†Èô§Êñá‰ª∂Â§±Ë¥•: ' + error.message, 'error');
        }
    }

    // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
    async handleFileUpload(files) {
        console.log('üîÑ ÂºÄÂßãÂ§ÑÁêÜÊñá‰ª∂‰∏ä‰º†:', files);
        
        if (!files || files.length === 0) {
            console.warn('‚ö†Ô∏è Ê≤°ÊúâÈÄâÊã©Êñá‰ª∂');
            return;
        }

        const file = files[0]; // ÁõÆÂâçÂè™ÊîØÊåÅÂçïÊñá‰ª∂‰∏ä‰º†
        console.log('üìÅ ÈÄâÊã©ÁöÑÊñá‰ª∂:', {
            name: file.name,
            size: file.size,
            type: file.type,
            lastModified: file.lastModified
        });

        // È™åËØÅÊñá‰ª∂Á±ªÂûã
        if (!this.options.allowedTypes.includes(file.type)) {
            console.error('‚ùå ‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã:', file.type, 'ÂÖÅËÆ∏ÁöÑÁ±ªÂûã:', this.options.allowedTypes);
            this.showStatus('‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã', 'error');
            return;
        }

        // È™åËØÅÊñá‰ª∂Â§ßÂ∞è
        if (file.size > this.options.maxFileSize) {
            console.error('‚ùå Êñá‰ª∂Â§ßÂ∞èË∂ÖËøáÈôêÂà∂:', file.size, 'ÊúÄÂ§ßÂÖÅËÆ∏:', this.options.maxFileSize);
            this.showStatus('Êñá‰ª∂Â§ßÂ∞èË∂ÖËøáÈôêÂà∂', 'error');
            return;
        }

        try {
            this.showStatus('Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...', 'info');
            console.log('üöÄ ÂºÄÂßã‰∏ä‰º†Êñá‰ª∂Âà∞API...');

            // Ê£ÄÊü•apiClientÊòØÂê¶Â≠òÂú®
            if (!window.apiClient) {
                throw new Error('ApiClientÊú™ÂàùÂßãÂåñ');
            }

            console.log('üåê ApiClient baseURL:', window.apiClient.baseURL);

            // Ë∞ÉÁî®‰∏ä‰º†API
            const response = await window.apiClient.upload('/api/upload', file);
            console.log('‚úÖ Êñá‰ª∂‰∏ä‰º†ÂìçÂ∫î:', response);
            
            // Â§ÑÁêÜ‰∏ä‰º†ÁªìÊûú
            if (response.data.multiple_sheets) {
                // Â§ö‰∏™Â∑•‰ΩúË°®
                this.fileList.push(...response.data.files);
            } else {
                // Âçï‰∏™Â∑•‰ΩúË°®
                this.fileList.push(response.data);
            }

            this.renderFileList();
            this.showStatus('Êñá‰ª∂‰∏ä‰º†ÊàêÂäü', 'success');

            // Ëß¶Âèë‰∏ä‰º†‰∫ã‰ª∂
            if (this.options.onUpload) {
                this.options.onUpload(response.data);
            }

            // ÂèëÈÄÅ‰∫ã‰ª∂
            window.eventBus?.emit('file.uploaded', response.data);

        } catch (error) {
            console.error('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•:', error);
            this.showStatus('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•: ' + error.message, 'error');
        }
    }

    // Âà∑Êñ∞Êñá‰ª∂ÂàóË°®
    async refresh() {
        await this.loadFileList();
        
        if (this.options.onRefresh) {
            this.options.onRefresh();
        }

        // ÂèëÈÄÅ‰∫ã‰ª∂
        window.eventBus?.emit('file.refreshed');
    }

    // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊñá‰ª∂
    getSelectedFile() {
        return this.fileList.find(f => f.file_id === this.selectedFileId);
    }

    // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊñá‰ª∂ID
    getSelectedFileId() {
        return this.selectedFileId;
    }

    // Ëé∑ÂèñÊâÄÊúâÊñá‰ª∂
    getAllFiles() {
        return [...this.fileList];
    }

    // ËÆæÁΩÆÈÄâ‰∏≠ÁöÑÊñá‰ª∂
    setSelectedFile(fileId) {
        this.selectFile(fileId);
    }

    // ÈîÄÊØÅÁªÑ‰ª∂
    destroy() {
        if (this.container) {
            this.container.innerHTML = '';
        }
    }
}

// ÂØºÂá∫ÁªÑ‰ª∂
window.FileSelector = FileSelector;