<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaPlot - æ•°æ®æ“ä½œ</title>
    
    <!-- æ–°çš„æ¨¡å—åŒ–æ¶æ„ -->
    <script src="src/utils/constants.js?v=2"></script>
    <script src="src/utils/helpers.js?v=2"></script>
    <script src="src/utils/validators.js?v=2"></script>
    <script src="src/utils/formatters.js?v=2"></script>
    <script src="src/core/ConfigManager.js"></script>
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/ApiClient.js"></script>
    <script src="src/core/AppState.js"></script>
    <script src="src/core/DataManager.js"></script>
    <script src="src/components/LoadingSpinner.js"></script>
    <script src="src/components/StatusMessage.js"></script>
    <script src="src/components/ErrorBoundary.js"></script>
    <script src="src/components/Modal.js"></script>
    <script src="src/components/FileSelector.js"></script>
    <script src="src/daplot.js"></script>
    
    <!-- æœ¬åœ°Luckysheet CSS (å¦‚æœå¯ç”¨) -->
    <link rel="stylesheet" href="assets/libs/luckysheet/plugins/css/pluginsCss.css" onerror="console.warn('Luckysheet CSS not found, using fallback')" />
    <link rel="stylesheet" href="assets/libs/luckysheet/plugins/plugins.css" onerror="console.warn('Luckysheet CSS not found')" />
    <link rel="stylesheet" href="assets/libs/luckysheet/css/luckysheet.css" onerror="console.warn('Luckysheet CSS not found')" />
    <link rel="stylesheet" href="assets/libs/luckysheet/assets/iconfont/iconfont.css" onerror="console.warn('Luckysheet CSS not found')" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            background: #f8f9fa;
            overflow: hidden;
        }

        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            flex-shrink: 0;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            transition: width 0.3s ease;
            padding: 15px;
            display: flex;
            flex-direction: column;
            font-size: 12px;
            position: relative;
            z-index: 1000;
        }        .s
idebar.collapsed {
            width: 50px;
            padding: 15px 5px;
        }

        .sidebar.collapsed .sidebar-content {
            display: none;
        }

        .sidebar-toggle {
            position: absolute;
            top: 15px;
            right: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1001;
        }

        .sidebar-toggle:hover {
            background: #0056b3;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: #333;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .sidebar-header h1 {
            font-size: 1.3rem;
            margin: 0;
            font-weight: 600;
        }

        .nav-bar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #666;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: rgba(74, 144, 226, 0.1);
            color: #4a90e2;
            transform: translateX(3px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .nav-btn i {
            margin-right: 10px;
            font-size: 16px;
            width: 16px;
            text-align: center;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            z-index: 999;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .spreadsheet-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .spreadsheet-header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .spreadsheet-header h3 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }

        .spreadsheet-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .sync-indicator.synced {
            background: #d4edda;
            color: #155724;
        }

        .sync-indicator.syncing {
            background: #fff3cd;
            color: #856404;
        }

        .sync-indicator.error {
            background: #f8d7da;
            color: #721c24;
        }

        .spreadsheet-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #luckysheet {
            width: 100%;
            height: 100%;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #6c757d;
            background: #fafafa;
        }

        .empty-state-content {
            max-width: 400px;
            padding: 40px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 18px;
        }

        .empty-state p {
            margin-bottom: 20px;
            line-height: 1.5;
            font-size: 14px;
        }

        .data-stats {
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: 12px;
            color: #6c757d;
        }

        .data-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .data-stat-value {
            font-weight: 600;
            color: #495057;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            
            .sidebar:not(.collapsed) {
                width: 250px;
            }
            
            .toolbar {
                padding: 10px 15px;
                gap: 10px;
            }
            
            .toolbar-group {
                gap: 5px;
            }
            
            .spreadsheet-header {
                padding: 12px 15px;
            }
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* éšè—æ–‡ä»¶è¾“å…¥ */
        #fileInput {
            display: none;
        }

        /* Luckysheet æ ·å¼è¦†ç›– */
        .luckysheet-wa-editor {
            z-index: 10 !important;
        }

        .luckysheet-modal {
            z-index: 1050 !important;
        }
    </style>
</head>
<body>    <!-- 
å…¨å±€åŠ è½½é®ç½© -->
    <div id="global-loading" style="display: none;"></div>
    
    <!-- å…¨å±€é”™è¯¯è¾¹ç•Œ -->
    <div id="global-error-boundary" style="display: none;"></div>

    <div class="page-wrapper">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
            
            <div class="sidebar-content">
                <div class="sidebar-header">
                    <h1>DaPlot</h1>
                </div>

                <nav class="nav-bar">
                    <a href="index.html" class="nav-btn">
                        <i>ğŸ </i>
                        <span>é¦–é¡µ</span>
                    </a>
                    <a href="data_integrated.html" class="nav-btn active">
                        <i>ğŸ“Š</i>
                        <span>æ•°æ®æ“ä½œ</span>
                    </a>
                    <a href="visualization.html" class="nav-btn">
                        <i>ğŸ“ˆ</i>
                        <span>å¯è§†åŒ–ç»˜å›¾</span>
                    </a>
                    <a href="prediction.html" class="nav-btn">
                        <i>ğŸ”®</i>
                        <span>æ•°æ®é¢„æµ‹</span>
                    </a>
                    <a href="donate.html" class="nav-btn">
                        <i>â¤ï¸</i>
                        <span>æèµ æ”¯æŒ</span>
                    </a>
                </nav>

                <!-- æ–‡ä»¶é€‰æ‹©å™¨ç»„ä»¶å®¹å™¨ -->
                <div id="file-selector-container"></div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="content-area">
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <div class="toolbar-group">
                    <span class="toolbar-label">æ–‡ä»¶æ“ä½œ:</span>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" multiple>
                    <button class="btn btn-primary" onclick="triggerFileUpload()">
                        ğŸ“ ä¸Šä¼ æ–‡ä»¶
                    </button>
                    <button class="btn btn-success" onclick="saveCurrentFile()" id="saveBtn" disabled>
                        ğŸ’¾ ä¿å­˜
                    </button>
                    <button class="btn btn-warning" onclick="exportData('xlsx')">
                        ğŸ“¤ å¯¼å‡ºExcel
                    </button>
                    <button class="btn btn-secondary" onclick="exportData('csv')">
                        ğŸ“„ å¯¼å‡ºCSV
                    </button>
                </div>

                <div class="toolbar-group">
                    <span class="toolbar-label">ç¼–è¾‘æ“ä½œ:</span>
                    <button class="btn btn-secondary" onclick="undoAction()" id="undoBtn" disabled>
                        â†¶ æ’¤é”€
                    </button>
                    <button class="btn btn-secondary" onclick="redoAction()" id="redoBtn" disabled>
                        â†· é‡åš
                    </button>
                    <button class="btn btn-danger" onclick="clearSheet()">
                        ğŸ—‘ï¸ æ¸…ç©º
                    </button>
                </div>

                <div class="toolbar-group">
                    <span class="toolbar-label">è§†å›¾:</span>
                    <button class="btn btn-secondary" onclick="toggleFullscreen()">
                        â›¶ å…¨å±
                    </button>
                </div>
            </div>

            <!-- ç”µå­è¡¨æ ¼å®¹å™¨ -->
            <div class="spreadsheet-container">
                <div class="spreadsheet-header">
                    <div>
                        <h3 id="current-file-name">æ•°æ®ç¼–è¾‘å™¨</h3>
                        <div class="data-stats" id="data-stats" style="display: none;">
                            <div class="data-stat">
                                <span>è¡Œæ•°:</span>
                                <span class="data-stat-value" id="row-count">0</span>
                            </div>
                            <div class="data-stat">
                                <span>åˆ—æ•°:</span>
                                <span class="data-stat-value" id="col-count">0</span>
                            </div>
                            <div class="data-stat">
                                <span>å·¥ä½œè¡¨:</span>
                                <span class="data-stat-value" id="sheet-count">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="spreadsheet-actions">
                        <div class="sync-indicator synced" id="sync-indicator">
                            <span>â—</span>
                            <span>å·²åŒæ­¥</span>
                        </div>
                    </div>
                </div>

                <div class="spreadsheet-content">
                    <div id="luckysheet"></div>
                    
                    <div class="empty-state" id="empty-state">
                        <div class="empty-state-content">
                            <div class="empty-state-icon">ğŸ“Š</div>
                            <h3>å¼€å§‹æ•°æ®ç¼–è¾‘</h3>
                            <p>ä¸Šä¼ Excelæˆ–CSVæ–‡ä»¶å¼€å§‹ç¼–è¾‘ï¼Œæˆ–è€…é€‰æ‹©å·²æœ‰æ–‡ä»¶è¿›è¡Œæ“ä½œ</p>
                            <button class="btn btn-primary" onclick="triggerFileUpload()">
                                ğŸ“ ä¸Šä¼ æ–‡ä»¶
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æœ¬åœ°Luckysheet JS (å¦‚æœå¯ç”¨) -->
    <script src="assets/libs/luckysheet/plugins/js/plugin.js" onerror="console.warn('Luckysheet plugin.js not found, using fallback')"></script>
    <script src="assets/libs/luckysheet/luckysheet.umd.js" onerror="console.warn('Luckysheet main JS not found, using fallback')"></script>  
  <script>
        // å…¨å±€å˜é‡
        let fileSelector = null;
        let globalLoading = null;
        let globalErrorBoundary = null;
        let luckysheetsInstance = null;
        let currentFileId = null;
        let currentFileName = '';
        let isDataModified = false;
        let autoSaveTimer = null;

        // é¡µé¢åˆå§‹åŒ–
        async function initializePage() {
            try {
                console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–æ•°æ®ç¼–è¾‘é¡µé¢...');

                // ç­‰å¾…DaPlotæ ¸å¿ƒæ¨¡å—åŠ è½½å®Œæˆ
                if (typeof window.initializeDaPlot === 'function') {
                    await window.initializeDaPlot();
                }

                // åˆå§‹åŒ–å…¨å±€ç»„ä»¶
                initializeGlobalComponents();

                // åˆå§‹åŒ–é¡µé¢ç»„ä»¶
                await initializePageComponents();

                // åˆå§‹åŒ–Luckysheet
                await initializeLuckysheet();

                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                bindEventListeners();

                // æ¢å¤é¡µé¢çŠ¶æ€
                restorePageState();

                console.log('âœ… æ•°æ®ç¼–è¾‘é¡µé¢åˆå§‹åŒ–å®Œæˆ');

            } catch (error) {
                console.error('âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // åˆå§‹åŒ–å…¨å±€ç»„ä»¶
        function initializeGlobalComponents() {
            // å…¨å±€åŠ è½½å™¨
            globalLoading = LoadingSpinner.createGlobal({
                text: 'æ­£åœ¨å¤„ç†...',
                type: 'spinner',
                size: 'large'
            });

            // å…¨å±€é”™è¯¯è¾¹ç•Œ
            globalErrorBoundary = ErrorBoundary.createGlobal({
                showDetails: true,
                allowRetry: true,
                onError: (error, errorInfo) => {
                    console.error('å…¨å±€é”™è¯¯:', error, errorInfo);
                }
            });
        }

        // åˆå§‹åŒ–é¡µé¢ç»„ä»¶
        async function initializePageComponents() {
            // åˆå§‹åŒ–æ–‡ä»¶é€‰æ‹©å™¨
            fileSelector = new FileSelector({
                container: 'file-selector-container',
                showUpload: true,
                showActions: true,
                onSelect: handleFileSelect,
                onDelete: handleFileDelete,
                onRefresh: handleFileRefresh
            });
        }

        // åˆå§‹åŒ–Luckysheet
        async function initializeLuckysheet() {
            try {
                // ç­‰å¾…LuckysheetåŠ è½½
                if (typeof luckysheet === 'undefined') {
                    throw new Error('Luckysheetåº“æœªåŠ è½½');
                }

                const options = {
                    container: 'luckysheet',
                    title: 'DaPlotæ•°æ®ç¼–è¾‘å™¨',
                    lang: 'zh',
                    allowCopy: true,
                    allowEdit: true,
                    allowUpdate: true,
                    showsheetbar: true,
                    showstatisticBar: true,
                    enableAddRow: true,
                    enableAddCol: true,
                    userInfo: false,
                    myFolderUrl: '',
                    devicePixelRatio: window.devicePixelRatio,
                    functionButton: '',
                    showConfigWindowResize: false,
                    forceCalculation: false,
                    
                    // å·¥å…·æ é…ç½®
                    showtoolbar: true,
                    showinfobar: true,
                    showsheetbarConfig: {
                        add: true,
                        menu: true,
                        sheet: true
                    },
                    
                    // å›è°ƒå‡½æ•°
                    hook: {
                        cellEditBefore: function(range) {
                            console.log('å¼€å§‹ç¼–è¾‘å•å…ƒæ ¼:', range);
                        },
                        cellUpdated: function(r, c, oldValue, newValue, isRefresh) {
                            if (!isRefresh) {
                                handleDataChange();
                            }
                        },
                        sheetActivate: function(index, isPivotInitial, isNewSheet) {
                            console.log('åˆ‡æ¢å·¥ä½œè¡¨:', index);
                            updateDataStats();
                        },
                        workbookCreateAfter: function() {
                            console.log('âœ… Luckysheetåˆå§‹åŒ–å®Œæˆ');
                            hideEmptyState();
                            updateDataStats();
                        }
                    }
                };

                // åˆå§‹åŒ–Luckysheet
                luckysheet.create(options);
                luckysheetsInstance = luckysheet;

                console.log('âœ… Luckysheetåˆå§‹åŒ–æˆåŠŸ');

            } catch (error) {
                console.error('âŒ Luckysheetåˆå§‹åŒ–å¤±è´¥:', error);
                throw error;
            }
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // ç›‘å¬åº”ç”¨çŠ¶æ€å˜åŒ–
            if (window.appState) {
                window.appState.subscribe('currentFileId', handleFileIdChange);
            }

            // ç›‘å¬äº‹ä»¶æ€»çº¿äº‹ä»¶
            if (window.eventBus) {
                window.eventBus.on('file.selected', handleFileSelectedEvent);
                window.eventBus.on('file.uploaded', handleFileUploadedEvent);
            }

            // æ–‡ä»¶è¾“å…¥å˜åŒ–
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileInputChange);

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // çª—å£å…³é—­å‰ä¿å­˜
            window.addEventListener('beforeunload', handleBeforeUnload);

            // å…¨å±çŠ¶æ€å˜åŒ–
            document.addEventListener('fullscreenchange', handleFullscreenChange);
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        async function handleFileSelect(file, fileId) {
            try {
                showLoading('æ­£åœ¨åŠ è½½æ–‡ä»¶æ•°æ®...');

                currentFileId = fileId;
                currentFileName = file.filename;

                // æ›´æ–°åº”ç”¨çŠ¶æ€
                if (window.appState) {
                    window.appState.setState({
                        currentFileId: fileId,
                        currentFileData: null
                    });
                }

                // åŠ è½½æ–‡ä»¶æ•°æ®åˆ°Luckysheet
                await loadFileToLuckysheet(fileId);

                // æ›´æ–°UI
                updateFileInfo(file);
                enableSaveButton();

                StatusMessage.notify(`æ–‡ä»¶ "${file.filename}" åŠ è½½æˆåŠŸ`, 'success');

            } catch (error) {
                console.error('æ–‡ä»¶é€‰æ‹©å¤±è´¥:', error);
                showError('æ–‡ä»¶åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½æ–‡ä»¶åˆ°Luckysheet
        async function loadFileToLuckysheet(fileId) {
            try {
                const fileData = await window.dataManager.getFileData(fileId);
                
                if (!fileData || !fileData.preview_data) {
                    throw new Error('æ–‡ä»¶æ•°æ®ä¸ºç©º');
                }

                // è½¬æ¢æ•°æ®æ ¼å¼ä¸ºLuckysheetæ ¼å¼
                const sheetData = convertToLuckysheetsFormat(fileData);

                // æ¸…ç©ºç°æœ‰æ•°æ®
                if (luckysheetsInstance) {
                    luckysheet.destroy();
                }

                // é‡æ–°åˆå§‹åŒ–Luckysheet withæ•°æ®
                const options = {
                    container: 'luckysheet',
                    title: currentFileName,
                    lang: 'zh',
                    data: sheetData,
                    hook: {
                        cellUpdated: function(r, c, oldValue, newValue, isRefresh) {
                            if (!isRefresh) {
                                handleDataChange();
                            }
                        },
                        workbookCreateAfter: function() {
                            hideEmptyState();
                            updateDataStats();
                        }
                    }
                };

                luckysheet.create(options);
                luckysheetsInstance = luckysheet;

            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶åˆ°Luckysheetå¤±è´¥:', error);
                throw error;
            }
        }

        // è½¬æ¢æ•°æ®æ ¼å¼ä¸ºLuckysheetæ ¼å¼
        function convertToLuckysheetsFormat(fileData) {
            const headers = fileData.headers || [];
            const data = fileData.preview_data || [];

            // åˆ›å»ºå·¥ä½œè¡¨æ•°æ®
            const cellData = [];

            // æ·»åŠ è¡¨å¤´
            if (headers.length > 0) {
                const headerRow = [];
                headers.forEach((header, colIndex) => {
                    headerRow.push({
                        r: 0,
                        c: colIndex,
                        v: {
                            v: header,
                            ct: { fa: 'General', t: 'g' },
                            m: header,
                            bg: '#f0f0f0',
                            bl: 1
                        }
                    });
                });
                cellData.push(...headerRow);
            }

            // æ·»åŠ æ•°æ®è¡Œ
            data.forEach((row, rowIndex) => {
                headers.forEach((header, colIndex) => {
                    const value = row[header];
                    if (value !== null && value !== undefined) {
                        cellData.push({
                            r: rowIndex + 1,
                            c: colIndex,
                            v: {
                                v: value,
                                ct: { fa: 'General', t: 'g' },
                                m: String(value)
                            }
                        });
                    }
                });
            });

            return [{
                name: currentFileName || 'å·¥ä½œè¡¨1',
                color: '',
                index: 0,
                status: 1,
                order: 0,
                hide: 0,
                row: Math.max(data.length + 1, 20),
                column: Math.max(headers.length, 10),
                defaultRowHeight: 19,
                defaultColWidth: 73,
                celldata: cellData,
                config: {
                    merge: {},
                    rowlen: {},
                    columnlen: {},
                    rowhidden: {},
                    colhidden: {},
                    borderInfo: [],
                    authority: {}
                },
                scrollLeft: 0,
                scrollTop: 0,
                luckysheet_select_save: [],
                calcChain: [],
                isPivotTable: false,
                pivotTable: {},
                filter_select: {},
                filter: null,
                luckysheet_alternateformat_save: [],
                luckysheet_alternateformat_save_modelCustom: [],
                luckysheet_conditionformat_save: {},
                frozen: {},
                chart: [],
                zoomRatio: 1,
                image: [],
                showGridLines: 1,
                dataVerification: {}
            }];
        }

        // æ•°æ®å˜æ›´å¤„ç†
        function handleDataChange() {
            isDataModified = true;
            updateSyncIndicator('syncing');
            
            // å¯ç”¨ä¿å­˜æŒ‰é’®
            enableSaveButton();
            
            // è®¾ç½®è‡ªåŠ¨ä¿å­˜
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            autoSaveTimer = setTimeout(() => {
                if (isDataModified && currentFileId) {
                    autoSaveData();
                }
            }, 5000); // 5ç§’åè‡ªåŠ¨ä¿å­˜
        }

        // è‡ªåŠ¨ä¿å­˜æ•°æ®
        async function autoSaveData() {
            try {
                await saveCurrentFile();
                console.log('âœ… æ•°æ®è‡ªåŠ¨ä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
            }
        }

        // ä¿å­˜å½“å‰æ–‡ä»¶
        async function saveCurrentFile() {
            if (!currentFileId || !luckysheetsInstance) {
                showError('æ²¡æœ‰å¯ä¿å­˜çš„æ–‡ä»¶');
                return;
            }

            try {
                showLoading('æ­£åœ¨ä¿å­˜æ–‡ä»¶...');
                updateSyncIndicator('syncing');

                // è·å–Luckysheetæ•°æ®
                const sheetData = luckysheet.getAllSheets();
                
                // è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
                const convertedData = convertFromLuckysheetsFormat(sheetData);

                // ä¿å­˜åˆ°æœåŠ¡å™¨
                const response = await window.apiClient.post('/api/save', {
                    file_id: currentFileId,
                    data: convertedData
                });

                if (response.data.success) {
                    isDataModified = false;
                    updateSyncIndicator('synced');
                    disableSaveButton();
                    StatusMessage.notify('æ–‡ä»¶ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    throw new Error(response.data.message || 'ä¿å­˜å¤±è´¥');
                }

            } catch (error) {
                console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
                updateSyncIndicator('error');
                showError('ä¿å­˜å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ä»Luckysheetæ ¼å¼è½¬æ¢
        function convertFromLuckysheetsFormat(sheetsData) {
            const result = [];
            
            sheetsData.forEach(sheet => {
                const sheetResult = {
                    name: sheet.name,
                    data: []
                };

                // è·å–æ•°æ®èŒƒå›´
                const maxRow = sheet.row || 0;
                const maxCol = sheet.column || 0;

                // è½¬æ¢å•å…ƒæ ¼æ•°æ®
                for (let r = 0; r < maxRow; r++) {
                    const row = {};
                    for (let c = 0; c < maxCol; c++) {
                        const cellData = sheet.celldata?.find(cell => cell.r === r && cell.c === c);
                        if (cellData && cellData.v && cellData.v.v !== null && cellData.v.v !== undefined) {
                            row[`col_${c}`] = cellData.v.v;
                        }
                    }
                    if (Object.keys(row).length > 0) {
                        sheetResult.data.push(row);
                    }
                }

                result.push(sheetResult);
            });

            return result;
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function triggerFileUpload() {
            document.getElementById('fileInput').click();
        }

        async function handleFileInputChange(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            try {
                showLoading('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...');

                for (const file of files) {
                    // éªŒè¯æ–‡ä»¶ç±»å‹
                    if (!isValidFileType(file)) {
                        showError(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.name}`);
                        continue;
                    }

                    // ä¸Šä¼ æ–‡ä»¶
                    const response = await window.apiClient.upload('/api/upload', file);
                    
                    if (response.data) {
                        StatusMessage.notify(`æ–‡ä»¶ "${file.name}" ä¸Šä¼ æˆåŠŸ`, 'success');
                        
                        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                        if (fileSelector) {
                            await fileSelector.refresh();
                        }
                    }
                }

            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                showError('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                event.target.value = '';
            }
        }

        // éªŒè¯æ–‡ä»¶ç±»å‹
        function isValidFileType(file) {
            const allowedTypes = [
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'text/csv'
            ];
            return allowedTypes.includes(file.type);
        }

        // å¯¼å‡ºæ•°æ®
        async function exportData(format) {
            if (!luckysheetsInstance) {
                showError('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }

            try {
                showLoading(`æ­£åœ¨å¯¼å‡º${format.toUpperCase()}æ ¼å¼...`);

                const sheetData = luckysheet.getAllSheets();
                const convertedData = convertFromLuckysheetsFormat(sheetData);

                // è°ƒç”¨å¯¼å‡ºAPI
                const response = await window.apiClient.post('/api/export', {
                    data: convertedData,
                    format: format,
                    filename: currentFileName || 'export'
                });

                if (response.data.download_url) {
                    // ä¸‹è½½æ–‡ä»¶
                    const link = document.createElement('a');
                    link.href = response.data.download_url;
                    link.download = response.data.filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    StatusMessage.notify(`æ•°æ®å·²å¯¼å‡ºä¸º${format.toUpperCase()}æ ¼å¼`, 'success');
                }

            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ’¤é”€æ“ä½œ
        function undoAction() {
            if (luckysheetsInstance && luckysheet.undo) {
                luckysheet.undo();
            }
        }

        // é‡åšæ“ä½œ
        function redoAction() {
            if (luckysheetsInstance && luckysheet.redo) {
                luckysheet.redo();
            }
        }

        // æ¸…ç©ºå·¥ä½œè¡¨
        async function clearSheet() {
            const confirmed = await Modal.confirm(
                'ç¡®å®šè¦æ¸…ç©ºå½“å‰å·¥ä½œè¡¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
                { title: 'ç¡®è®¤æ¸…ç©º' }
            );

            if (confirmed && luckysheetsInstance) {
                luckysheet.clearRange();
                handleDataChange();
                StatusMessage.notify('å·¥ä½œè¡¨å·²æ¸…ç©º', 'info');
            }
        }

        // å…¨å±åˆ‡æ¢
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // UIæ›´æ–°å‡½æ•°
        function updateFileInfo(file) {
            document.getElementById('current-file-name').textContent = file.filename;
            showDataStats();
        }

        function showDataStats() {
            document.getElementById('data-stats').style.display = 'flex';
        }

        function hideDataStats() {
            document.getElementById('data-stats').style.display = 'none';
        }

        function updateDataStats() {
            if (!luckysheetsInstance) return;

            try {
                const sheets = luckysheet.getAllSheets();
                const currentSheet = luckysheet.getSheet();
                
                if (currentSheet) {
                    document.getElementById('row-count').textContent = currentSheet.row || 0;
                    document.getElementById('col-count').textContent = currentSheet.column || 0;
                }
                
                document.getElementById('sheet-count').textContent = sheets.length;
            } catch (error) {
                console.error('æ›´æ–°æ•°æ®ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        function updateSyncIndicator(status) {
            const indicator = document.getElementById('sync-indicator');
            indicator.className = `sync-indicator ${status}`;
            
            const statusText = {
                synced: 'å·²åŒæ­¥',
                syncing: 'åŒæ­¥ä¸­...',
                error: 'åŒæ­¥å¤±è´¥'
            };
            
            indicator.querySelector('span:last-child').textContent = statusText[status] || 'æœªçŸ¥çŠ¶æ€';
        }

        function enableSaveButton() {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = false;
        }

        function disableSaveButton() {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
        }

        function hideEmptyState() {
            document.getElementById('empty-state').style.display = 'none';
        }

        function showEmptyState() {
            document.getElementById('empty-state').style.display = 'flex';
        }

        // äº‹ä»¶å¤„ç†å‡½æ•°
        function handleFileDelete(fileId) {
            if (fileId === currentFileId) {
                // æ¸…ç©ºå½“å‰ç¼–è¾‘å™¨
                if (luckysheetsInstance) {
                    luckysheet.destroy();
                    luckysheetsInstance = null;
                }
                
                currentFileId = null;
                currentFileName = '';
                isDataModified = false;
                
                showEmptyState();
                hideDataStats();
                disableSaveButton();
                updateSyncIndicator('synced');
            }
            
            StatusMessage.notify('æ–‡ä»¶åˆ é™¤æˆåŠŸ', 'success');
        }

        function handleFileRefresh() {
            StatusMessage.notify('æ–‡ä»¶åˆ—è¡¨å·²åˆ·æ–°', 'info');
        }

        function handleFileIdChange(newFileId, oldFileId) {
            if (newFileId !== oldFileId) {
                currentFileId = newFileId;
            }
        }

        function handleFileSelectedEvent(data) {
            console.log('æ–‡ä»¶é€‰æ‹©äº‹ä»¶:', data);
        }

        function handleFileUploadedEvent(data) {
            console.log('æ–‡ä»¶ä¸Šä¼ äº‹ä»¶:', data);
        }

        function handleKeyboardShortcuts(e) {
            // Ctrl+S: ä¿å­˜
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (currentFileId && !document.getElementById('saveBtn').disabled) {
                    saveCurrentFile();
                }
            }
            
            // Ctrl+Z: æ’¤é”€
            if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undoAction();
            }
            
            // Ctrl+Y æˆ– Ctrl+Shift+Z: é‡åš
            if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) {
                e.preventDefault();
                redoAction();
            }
        }

        function handleBeforeUnload(e) {
            if (isDataModified) {
                e.preventDefault();
                e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                return e.returnValue;
            }
        }

        function handleFullscreenChange() {
            // å…¨å±çŠ¶æ€å˜åŒ–æ—¶è°ƒæ•´Luckysheetå¤§å°
            if (luckysheetsInstance) {
                setTimeout(() => {
                    luckysheet.resize();
                }, 100);
            }
        }

        // å·¥å…·å‡½æ•°
        function showLoading(text = 'åŠ è½½ä¸­...') {
            if (globalLoading) {
                globalLoading.show(text);
            }
        }

        function hideLoading() {
            if (globalLoading) {
                globalLoading.hide();
            }
        }

        function showError(message) {
            StatusMessage.error(message, { autoCloseDelay: 5000 });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            
            // è°ƒæ•´Luckysheetå¤§å°
            setTimeout(() => {
                if (luckysheetsInstance) {
                    luckysheet.resize();
                }
            }, 300);
        }

        function restorePageState() {
            // ä»åº”ç”¨çŠ¶æ€æ¢å¤é¡µé¢çŠ¶æ€
            if (window.appState) {
                const currentFileId = window.appState.getState('currentFileId');
                if (currentFileId && fileSelector) {
                    fileSelector.setSelectedFile(currentFileId);
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializePage);

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            if (fileSelector) fileSelector.destroy();
            if (globalLoading) globalLoading.destroy();
            if (globalErrorBoundary) globalErrorBoundary.destroy();
            
            if (luckysheetsInstance) {
                luckysheet.destroy();
            }
        });
    </script>
</body>
</html>