<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaPlot - æ•°æ®é¢„æµ‹</title>
    
    <!-- æ–°çš„æ¨¡å—åŒ–æ¶æ„ -->
    <script src="src/utils/constants.js"></script>
    <script src="src/utils/helpers.js"></script>
    <script src="src/utils/validators.js"></script>
    <script src="src/utils/formatters.js"></script>
    <script src="src/core/ConfigManager.js"></script>
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/ApiClient.js"></script>
    <script src="src/core/AppState.js"></script>
    <script src="src/core/DataManager.js"></script>
    <script src="src/core/ChartEngine.js"></script>
    <script src="src/components/LoadingSpinner.js"></script>
    <script src="src/components/StatusMessage.js"></script>
    <script src="src/components/ErrorBoundary.js"></script>
    <script src="src/components/Modal.js"></script>
    <script src="src/components/FileSelector.js"></script>
    <script src="src/components/DataFilter.js"></script>
    <script src="src/daplot.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            overflow-x: hidden;
        }

        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            flex-shrink: 0;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            transition: width 0.3s ease;
            padding: 15px;
            display: flex;
            flex-direction: column;
            font-size: 12px;
            position: relative;
        }       
 .sidebar.collapsed {
            width: 50px;
            padding: 15px 5px;
        }

        .sidebar.collapsed .sidebar-content {
            display: none;
        }

        .sidebar-toggle {
            position: absolute;
            top: 15px;
            right: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
        }

        .sidebar-toggle:hover {
            background: #0056b3;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: #333;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .sidebar-header h1 {
            font-size: 1.3rem;
            margin: 0;
            font-weight: 600;
        }

        .nav-bar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #666;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: rgba(74, 144, 226, 0.1);
            color: #4a90e2;
            transform: translateX(3px);
        }      
  .nav-btn.active {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .nav-btn i {
            margin-right: 10px;
            font-size: 16px;
            width: 16px;
            text-align: center;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            align-items: start;
        }

        .controls-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            overflow: hidden;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .prediction-area {
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            padding: 20px;
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .prediction-config {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .config-section {
            margin-bottom: 15px;
        }

        .config-section h4 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
            font-size: 12px;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }     
   .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .prediction-results {
            flex: 1;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
        }

        .results-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-content {
            flex: 1;
            padding: 15px;
            min-height: 400px;
        }

        .no-results-message {
            text-align: center;
            color: #6c757d;
            padding: 40px;
        }

        .algorithm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .algorithm-card {
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .algorithm-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
        }

        .algorithm-card.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .algorithm-card h5 {
            margin: 0 0 5px 0;
            font-size: 13px;
            color: #333;
        }

        .algorithm-card p {
            margin: 0;
            font-size: 11px;
            color: #6c757d;
        }

        .prediction-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            padding: 10px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #007bff;
        }

        .stat-label {
            font-size: 11px;
            color: #6c757d;
            margin-top: 2px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 300px 1fr;
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            
            .sidebar:not(.collapsed) {
                width: 250px;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                padding: 15px;
            }
            
            .controls-panel {
                position: static;
            }
        }
    </style>
</head>
<body>    
<!-- å…¨å±€åŠ è½½é®ç½© -->
    <div id="global-loading" style="display: none;"></div>
    
    <!-- å…¨å±€é”™è¯¯è¾¹ç•Œ -->
    <div id="global-error-boundary" style="display: none;"></div>

    <div class="page-wrapper">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
            
            <div class="sidebar-content">
                <div class="sidebar-header">
                    <h1>DaPlot</h1>
                </div>

                <nav class="nav-bar">
                    <a href="index.html" class="nav-btn">
                        <i>ğŸ </i>
                        <span>é¦–é¡µ</span>
                    </a>
                    <a href="data_integrated.html" class="nav-btn">
                        <i>ğŸ“Š</i>
                        <span>æ•°æ®æ“ä½œ</span>
                    </a>
                    <a href="visualization.html" class="nav-btn">
                        <i>ğŸ“ˆ</i>
                        <span>å¯è§†åŒ–ç»˜å›¾</span>
                    </a>
                    <a href="prediction.html" class="nav-btn active">
                        <i>ğŸ”®</i>
                        <span>æ•°æ®é¢„æµ‹</span>
                    </a>
                    <a href="donate.html" class="nav-btn">
                        <i>â¤ï¸</i>
                        <span>æèµ æ”¯æŒ</span>
                    </a>
                </nav>

                <!-- æ–‡ä»¶é€‰æ‹©å™¨ç»„ä»¶å®¹å™¨ -->
                <div id="file-selector-container"></div>

                <!-- æ•°æ®ç­›é€‰å™¨ç»„ä»¶å®¹å™¨ -->
                <div id="data-filter-container"></div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="content">
            <div class="main-content">
                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="controls-panel">
                    <!-- é¢„æµ‹é…ç½® -->
                    <div class="prediction-config">
                        <div class="config-section">
                            <h4>ğŸ¯ é¢„æµ‹ç›®æ ‡</h4>
                            <div class="form-group">
                                <label for="target-column">ç›®æ ‡å˜é‡:</label>
                                <select id="target-column" class="form-control">
                                    <option value="">è¯·é€‰æ‹©ç›®æ ‡å˜é‡</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="feature-columns">ç‰¹å¾å˜é‡:</label>
                                <select id="feature-columns" class="form-control" multiple>
                                    <option value="">è¯·é€‰æ‹©ç‰¹å¾å˜é‡</option>
                                </select>
                            </div>
                        </div>

                        <div class="config-section">
                            <h4>ğŸ¤– ç®—æ³•é€‰æ‹©</h4>
                            <div class="algorithm-grid" id="algorithm-grid">
                                <!-- ç®—æ³•é€‰æ‹©å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>

                        <div class="config-section">
                            <h4>âš™ï¸ å‚æ•°è®¾ç½®</h4>
                            <div class="form-group">
                                <label for="prediction-steps">é¢„æµ‹æ­¥æ•°:</label>
                                <input type="number" id="prediction-steps" class="form-control" 
                                       value="10" min="1" max="50">
                            </div>
                            <div class="form-group">
                                <label for="train-ratio">è®­ç»ƒæ¯”ä¾‹:</label>
                                <input type="range" id="train-ratio" class="form-control" 
                                       value="0.8" min="0.5" max="0.95" step="0.05">
                                <small>å½“å‰: <span id="train-ratio-value">80%</span></small>
                            </div>
                        </div>

                        <div class="config-section">
                            <button class="btn btn-primary" id="start-prediction" onclick="startPrediction()" disabled>
                                ğŸš€ å¼€å§‹é¢„æµ‹
                            </button>
                            <button class="btn btn-secondary" id="clear-results" onclick="clearResults()">
                                ğŸ§¹ æ¸…é™¤ç»“æœ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- é¢„æµ‹ç»“æœåŒºåŸŸ -->
                <div class="prediction-area">
                    <!-- é¢„æµ‹ç»Ÿè®¡ -->
                    <div class="prediction-stats" id="prediction-stats" style="display: none;">
                        <div class="stat-card">
                            <div class="stat-value" id="accuracy-value">-</div>
                            <div class="stat-label">å‡†ç¡®ç‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="mse-value">-</div>
                            <div class="stat-label">å‡æ–¹è¯¯å·®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="r2-value">-</div>
                            <div class="stat-label">RÂ²åˆ†æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="training-time">-</div>
                            <div class="stat-label">è®­ç»ƒæ—¶é—´</div>
                        </div>
                    </div>

                    <!-- é¢„æµ‹ç»“æœ -->
                    <div class="prediction-results">
                        <div class="results-header">
                            <h4>ğŸ“Š é¢„æµ‹ç»“æœ</h4>
                            <div>
                                <button class="btn btn-secondary" onclick="downloadResults('csv')" id="download-csv" style="display: none;">
                                    ğŸ“„ å¯¼å‡ºCSV
                                </button>
                                <button class="btn btn-secondary" onclick="downloadResults('png')" id="download-png" style="display: none;">
                                    ğŸ“· ä¿å­˜å›¾è¡¨
                                </button>
                            </div>
                        </div>
                        <div class="results-content" id="results-content">
                            <div class="no-results-message">
                                <h3>ğŸ”® é¢„æµ‹ç»“æœåŒºåŸŸ</h3>
                                <p>è¯·é€‰æ‹©æ•°æ®æ–‡ä»¶ã€é…ç½®é¢„æµ‹å‚æ•°ï¼Œç„¶åå¼€å§‹é¢„æµ‹</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>    <
script>
        // å…¨å±€å˜é‡
        let fileSelector = null;
        let dataFilter = null;
        let globalLoading = null;
        let globalErrorBoundary = null;
        let currentPrediction = null;
        let selectedAlgorithm = 'linear';
        let predictionChart = null;

        // é¢„æµ‹ç®—æ³•é…ç½®
        const algorithms = {
            linear: {
                name: 'çº¿æ€§å›å½’',
                description: 'é€‚ç”¨äºçº¿æ€§å…³ç³»çš„æ•°æ®',
                category: 'traditional'
            },
            polynomial: {
                name: 'å¤šé¡¹å¼å›å½’',
                description: 'é€‚ç”¨äºéçº¿æ€§å…³ç³»çš„æ•°æ®',
                category: 'traditional'
            },
            svr: {
                name: 'æ”¯æŒå‘é‡å›å½’',
                description: 'é€‚ç”¨äºå¤æ‚éçº¿æ€§æ•°æ®',
                category: 'machine_learning'
            },
            randomforest: {
                name: 'éšæœºæ£®æ—',
                description: 'é›†æˆå­¦ä¹ ï¼Œé²æ£’æ€§å¼º',
                category: 'machine_learning'
            },
            xgboost: {
                name: 'XGBoost',
                description: 'æ¢¯åº¦æå‡ï¼Œæ€§èƒ½ä¼˜å¼‚',
                category: 'machine_learning'
            },
            lstm: {
                name: 'LSTMç¥ç»ç½‘ç»œ',
                description: 'é€‚ç”¨äºæ—¶é—´åºåˆ—é¢„æµ‹',
                category: 'machine_learning'
            }
        };

        // é¡µé¢åˆå§‹åŒ–
        async function initializePage() {
            try {
                console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–é¢„æµ‹é¡µé¢...');

                // ç­‰å¾…DaPlotæ ¸å¿ƒæ¨¡å—åŠ è½½å®Œæˆ
                if (typeof window.initializeDaPlot === 'function') {
                    await window.initializeDaPlot();
                }

                // åˆå§‹åŒ–å…¨å±€ç»„ä»¶
                initializeGlobalComponents();

                // åˆå§‹åŒ–é¡µé¢ç»„ä»¶
                await initializePageComponents();

                // æ¸²æŸ“ç®—æ³•é€‰æ‹©
                renderAlgorithmGrid();

                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                bindEventListeners();

                // æ¢å¤é¡µé¢çŠ¶æ€
                restorePageState();

                console.log('âœ… é¢„æµ‹é¡µé¢åˆå§‹åŒ–å®Œæˆ');

            } catch (error) {
                console.error('âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // åˆå§‹åŒ–å…¨å±€ç»„ä»¶
        function initializeGlobalComponents() {
            // å…¨å±€åŠ è½½å™¨
            globalLoading = LoadingSpinner.createGlobal({
                text: 'æ­£åœ¨å¤„ç†...',
                type: 'spinner',
                size: 'large'
            });

            // å…¨å±€é”™è¯¯è¾¹ç•Œ
            globalErrorBoundary = ErrorBoundary.createGlobal({
                showDetails: true,
                allowRetry: true,
                onError: (error, errorInfo) => {
                    console.error('å…¨å±€é”™è¯¯:', error, errorInfo);
                }
            });
        }

        // åˆå§‹åŒ–é¡µé¢ç»„ä»¶
        async function initializePageComponents() {
            // åˆå§‹åŒ–æ–‡ä»¶é€‰æ‹©å™¨
            fileSelector = new FileSelector({
                container: 'file-selector-container',
                showUpload: true,
                showActions: true,
                onSelect: handleFileSelect,
                onDelete: handleFileDelete,
                onRefresh: handleFileRefresh
            });

            // åˆå§‹åŒ–æ•°æ®ç­›é€‰å™¨
            dataFilter = new DataFilter({
                container: 'data-filter-container',
                showPreview: true,
                showClear: true,
                onChange: handleFilterChange,
                onApply: handleFilterApply
            });
        }

        // æ¸²æŸ“ç®—æ³•é€‰æ‹©ç½‘æ ¼
        function renderAlgorithmGrid() {
            const grid = document.getElementById('algorithm-grid');
            grid.innerHTML = Object.entries(algorithms).map(([key, algo]) => `
                <div class="algorithm-card ${key === selectedAlgorithm ? 'selected' : ''}" 
                     data-algorithm="${key}" onclick="selectAlgorithm('${key}')">
                    <h5>${algo.name}</h5>
                    <p>${algo.description}</p>
                </div>
            `).join('');
        }

        // é€‰æ‹©ç®—æ³•
        function selectAlgorithm(algorithm) {
            selectedAlgorithm = algorithm;
            
            // æ›´æ–°UI
            document.querySelectorAll('.algorithm-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-algorithm="${algorithm}"]`).classList.add('selected');
            
            console.log('é€‰æ‹©ç®—æ³•:', algorithms[algorithm].name);
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // ç›‘å¬åº”ç”¨çŠ¶æ€å˜åŒ–
            if (window.appState) {
                window.appState.subscribe('currentFileId', handleFileIdChange);
                window.appState.subscribe('filters', handleFiltersStateChange);
            }

            // ç›‘å¬äº‹ä»¶æ€»çº¿äº‹ä»¶
            if (window.eventBus) {
                window.eventBus.on('file.selected', handleFileSelectedEvent);
                window.eventBus.on('dataFilter.changed', handleDataFilterChangedEvent);
            }

            // è®­ç»ƒæ¯”ä¾‹æ»‘å—
            const trainRatioSlider = document.getElementById('train-ratio');
            const trainRatioValue = document.getElementById('train-ratio-value');
            
            trainRatioSlider.addEventListener('input', (e) => {
                const value = Math.round(e.target.value * 100);
                trainRatioValue.textContent = `${value}%`;
            });

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        async function handleFileSelect(file, fileId) {
            try {
                showLoading('æ­£åœ¨åŠ è½½æ–‡ä»¶æ•°æ®...');

                // æ›´æ–°åº”ç”¨çŠ¶æ€
                if (window.appState) {
                    window.appState.setState({
                        currentFileId: fileId,
                        currentFileData: null
                    });
                }

                // æ›´æ–°æ•°æ®ç­›é€‰å™¨
                if (dataFilter) {
                    dataFilter.setFileId(fileId);
                }

                // åŠ è½½åˆ—ä¿¡æ¯å¹¶æ›´æ–°é€‰æ‹©å™¨
                await updateColumnSelectors(fileId);

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                StatusMessage.notify(`æ–‡ä»¶ "${file.filename}" åŠ è½½æˆåŠŸ`, 'success');

            } catch (error) {
                console.error('æ–‡ä»¶é€‰æ‹©å¤±è´¥:', error);
                showError('æ–‡ä»¶åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ›´æ–°åˆ—é€‰æ‹©å™¨
        async function updateColumnSelectors(fileId) {
            try {
                const fileData = await window.dataManager.getFileData(fileId);
                const headers = fileData.headers || [];

                // æ›´æ–°ç›®æ ‡å˜é‡é€‰æ‹©å™¨
                const targetSelect = document.getElementById('target-column');
                targetSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç›®æ ‡å˜é‡</option>' +
                    headers.map(header => `<option value="${header}">${header}</option>`).join('');

                // æ›´æ–°ç‰¹å¾å˜é‡é€‰æ‹©å™¨
                const featureSelect = document.getElementById('feature-columns');
                featureSelect.innerHTML = headers.map(header => 
                    `<option value="${header}">${header}</option>`
                ).join('');

                // å¯ç”¨é¢„æµ‹æŒ‰é’®
                updatePredictionButton();

            } catch (error) {
                console.error('æ›´æ–°åˆ—é€‰æ‹©å™¨å¤±è´¥:', error);
                throw error;
            }
        }

        // æ›´æ–°é¢„æµ‹æŒ‰é’®çŠ¶æ€
        function updatePredictionButton() {
            const targetColumn = document.getElementById('target-column').value;
            const featureColumns = Array.from(document.getElementById('feature-columns').selectedOptions).map(opt => opt.value);
            const currentFileId = window.appState?.getState('currentFileId');

            const canPredict = currentFileId && targetColumn && featureColumns.length > 0;
            document.getElementById('start-prediction').disabled = !canPredict;
        }

        // å¼€å§‹é¢„æµ‹
        async function startPrediction() {
            try {
                const currentFileId = window.appState?.getState('currentFileId');
                if (!currentFileId) {
                    throw new Error('è¯·å…ˆé€‰æ‹©æ•°æ®æ–‡ä»¶');
                }

                const targetColumn = document.getElementById('target-column').value;
                const featureColumns = Array.from(document.getElementById('feature-columns').selectedOptions).map(opt => opt.value);
                const predictionSteps = parseInt(document.getElementById('prediction-steps').value);
                const trainRatio = parseFloat(document.getElementById('train-ratio').value);

                if (!targetColumn) {
                    throw new Error('è¯·é€‰æ‹©ç›®æ ‡å˜é‡');
                }

                if (featureColumns.length === 0) {
                    throw new Error('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªç‰¹å¾å˜é‡');
                }

                showLoading('æ­£åœ¨è¿›è¡Œé¢„æµ‹åˆ†æ...');

                // è·å–ç­›é€‰åçš„æ•°æ®
                const filters = window.appState?.getState('filters') || {};

                // è°ƒç”¨é¢„æµ‹API
                const predictionData = {
                    file_id: currentFileId,
                    target_column: targetColumn,
                    feature_columns: featureColumns,
                    algorithm: selectedAlgorithm,
                    prediction_steps: predictionSteps,
                    train_ratio: trainRatio,
                    filters: filters
                };

                const response = await window.apiClient.post('/api/predict', predictionData);
                currentPrediction = response.data;

                // æ˜¾ç¤ºé¢„æµ‹ç»“æœ
                displayPredictionResults(currentPrediction);

                StatusMessage.notify('é¢„æµ‹å®Œæˆï¼', 'success');

            } catch (error) {
                console.error('é¢„æµ‹å¤±è´¥:', error);
                showError('é¢„æµ‹å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºé¢„æµ‹ç»“æœ
        async function displayPredictionResults(results) {
            try {
                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                displayPredictionStats(results.metrics || {});

                // æ˜¾ç¤ºé¢„æµ‹å›¾è¡¨
                await displayPredictionChart(results);

                // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                document.getElementById('download-csv').style.display = 'inline-block';
                document.getElementById('download-png').style.display = 'inline-block';

                // éšè—æ— ç»“æœæ¶ˆæ¯
                const noResultsMessage = document.querySelector('.no-results-message');
                if (noResultsMessage) {
                    noResultsMessage.style.display = 'none';
                }

            } catch (error) {
                console.error('æ˜¾ç¤ºé¢„æµ‹ç»“æœå¤±è´¥:', error);
                throw error;
            }
        }

        // æ˜¾ç¤ºé¢„æµ‹ç»Ÿè®¡
        function displayPredictionStats(metrics) {
            const statsContainer = document.getElementById('prediction-stats');
            
            document.getElementById('accuracy-value').textContent = 
                metrics.accuracy ? `${(metrics.accuracy * 100).toFixed(1)}%` : '-';
            document.getElementById('mse-value').textContent = 
                metrics.mse ? metrics.mse.toFixed(4) : '-';
            document.getElementById('r2-value').textContent = 
                metrics.r2_score ? metrics.r2_score.toFixed(3) : '-';
            document.getElementById('training-time').textContent = 
                metrics.training_time ? `${metrics.training_time.toFixed(2)}s` : '-';

            statsContainer.style.display = 'grid';
        }

        // æ˜¾ç¤ºé¢„æµ‹å›¾è¡¨
        async function displayPredictionChart(results) {
            const resultsContent = document.getElementById('results-content');
            
            // æ¸…é™¤ç°æœ‰å†…å®¹
            resultsContent.innerHTML = '<div id="prediction-chart" style="width: 100%; height: 400px;"></div>';

            // å‡†å¤‡å›¾è¡¨æ•°æ®
            const chartData = [
                {
                    x: results.actual_x || [],
                    y: results.actual_y || [],
                    mode: 'markers',
                    type: 'scatter',
                    name: 'å®é™…å€¼',
                    marker: { color: '#007bff', size: 6 }
                },
                {
                    x: results.predicted_x || [],
                    y: results.predicted_y || [],
                    mode: 'lines+markers',
                    type: 'scatter',
                    name: 'é¢„æµ‹å€¼',
                    line: { color: '#dc3545', width: 2 },
                    marker: { color: '#dc3545', size: 4 }
                }
            ];

            const layout = {
                title: `${algorithms[selectedAlgorithm].name} é¢„æµ‹ç»“æœ`,
                xaxis: { title: 'æ—¶é—´/åºåˆ—' },
                yaxis: { title: 'æ•°å€¼' },
                showlegend: true,
                margin: { t: 50, r: 50, b: 50, l: 50 }
            };

            // åˆ›å»ºå›¾è¡¨
            if (window.chartEngine) {
                await window.chartEngine.createChart('prediction-chart', chartData, layout);
                predictionChart = true;
            }
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            currentPrediction = null;
            predictionChart = null;

            // éšè—ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('prediction-stats').style.display = 'none';

            // éšè—ä¸‹è½½æŒ‰é’®
            document.getElementById('download-csv').style.display = 'none';
            document.getElementById('download-png').style.display = 'none';

            // æ¸…é™¤å›¾è¡¨
            if (window.chartEngine && window.chartEngine.hasChart('prediction-chart')) {
                window.chartEngine.destroyChart('prediction-chart');
            }

            // æ˜¾ç¤ºæ— ç»“æœæ¶ˆæ¯
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = `
                <div class="no-results-message">
                    <h3>ğŸ”® é¢„æµ‹ç»“æœåŒºåŸŸ</h3>
                    <p>è¯·é€‰æ‹©æ•°æ®æ–‡ä»¶ã€é…ç½®é¢„æµ‹å‚æ•°ï¼Œç„¶åå¼€å§‹é¢„æµ‹</p>
                </div>
            `;

            StatusMessage.notify('é¢„æµ‹ç»“æœå·²æ¸…é™¤', 'info');
        }

        // ä¸‹è½½ç»“æœ
        async function downloadResults(format) {
            if (!currentPrediction) {
                showError('æ²¡æœ‰å¯ä¸‹è½½çš„é¢„æµ‹ç»“æœ');
                return;
            }

            try {
                showLoading(`æ­£åœ¨å¯¼å‡º${format.toUpperCase()}æ ¼å¼...`);

                if (format === 'csv') {
                    // å¯¼å‡ºCSVæ•°æ®
                    const csvData = prepareCsvData(currentPrediction);
                    downloadCsv(csvData, `prediction-results-${Date.now()}.csv`);
                } else if (format === 'png') {
                    // å¯¼å‡ºå›¾è¡¨
                    if (predictionChart && window.chartEngine) {
                        await window.chartEngine.downloadChart('prediction-chart', {
                            format: 'png',
                            filename: `prediction-chart-${Date.now()}`,
                            width: 800,
                            height: 600
                        });
                    }
                }

                StatusMessage.notify(`é¢„æµ‹ç»“æœå·²å¯¼å‡ºä¸º${format.toUpperCase()}æ ¼å¼`, 'success');

            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // å‡†å¤‡CSVæ•°æ®
        function prepareCsvData(results) {
            const headers = ['Index', 'Actual', 'Predicted'];
            const rows = [];

            const actualY = results.actual_y || [];
            const predictedY = results.predicted_y || [];
            const maxLength = Math.max(actualY.length, predictedY.length);

            for (let i = 0; i < maxLength; i++) {
                rows.push([
                    i + 1,
                    actualY[i] || '',
                    predictedY[i] || ''
                ]);
            }

            return [headers, ...rows];
        }

        // ä¸‹è½½CSVæ–‡ä»¶
        function downloadCsv(data, filename) {
            const csvContent = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // äº‹ä»¶å¤„ç†å‡½æ•°
        function handleFileDelete(fileId) {
            const currentFileId = window.appState?.getState('currentFileId');
            if (fileId === currentFileId) {
                clearResults();
                
                // æ¸…ç©ºåˆ—é€‰æ‹©å™¨
                document.getElementById('target-column').innerHTML = '<option value="">è¯·é€‰æ‹©ç›®æ ‡å˜é‡</option>';
                document.getElementById('feature-columns').innerHTML = '';
                
                updatePredictionButton();
            }
            StatusMessage.notify('æ–‡ä»¶åˆ é™¤æˆåŠŸ', 'success');
        }

        function handleFileRefresh() {
            StatusMessage.notify('æ–‡ä»¶åˆ—è¡¨å·²åˆ·æ–°', 'info');
        }

        function handleFilterChange(filters) {
            if (window.appState) {
                window.appState.setState({ filters });
            }
        }

        function handleFilterApply(filters) {
            StatusMessage.notify('ç­›é€‰æ¡ä»¶å·²åº”ç”¨', 'success');
        }

        function handleFileIdChange(newFileId, oldFileId) {
            if (newFileId !== oldFileId) {
                clearResults();
            }
        }

        function handleFiltersStateChange(newFilters, oldFilters) {
            if (dataFilter && JSON.stringify(newFilters) !== JSON.stringify(oldFilters)) {
                dataFilter.setFilters(newFilters);
            }
        }

        function handleFileSelectedEvent(data) {
            console.log('æ–‡ä»¶é€‰æ‹©äº‹ä»¶:', data);
        }

        function handleDataFilterChangedEvent(data) {
            console.log('æ•°æ®ç­›é€‰å˜æ›´äº‹ä»¶:', data);
        }

        function handleKeyboardShortcuts(e) {
            // Ctrl+Enter: å¼€å§‹é¢„æµ‹
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const startBtn = document.getElementById('start-prediction');
                if (!startBtn.disabled) {
                    startPrediction();
                }
            }
            
            // Ctrl+R: åˆ·æ–°æ•°æ®
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                if (fileSelector) {
                    fileSelector.refresh();
                }
            }
        }

        // å·¥å…·å‡½æ•°
        function showLoading(text = 'åŠ è½½ä¸­...') {
            if (globalLoading) {
                globalLoading.show(text);
            }
        }

        function hideLoading() {
            if (globalLoading) {
                globalLoading.hide();
            }
        }

        function showError(message) {
            StatusMessage.error(message, { autoCloseDelay: 5000 });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function restorePageState() {
            // ä»åº”ç”¨çŠ¶æ€æ¢å¤é¡µé¢çŠ¶æ€
            if (window.appState) {
                const currentFileId = window.appState.getState('currentFileId');
                if (currentFileId && fileSelector) {
                    fileSelector.setSelectedFile(currentFileId);
                    updateColumnSelectors(currentFileId);
                }

                const filters = window.appState.getState('filters');
                if (filters && dataFilter) {
                    dataFilter.setFilters(filters);
                }
            }
        }

        // ç›‘å¬åˆ—é€‰æ‹©å˜åŒ–
        document.addEventListener('change', (e) => {
            if (e.target.id === 'target-column' || e.target.id === 'feature-columns') {
                updatePredictionButton();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializePage);

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (fileSelector) fileSelector.destroy();
            if (dataFilter) dataFilter.destroy();
            if (globalLoading) globalLoading.destroy();
            if (globalErrorBoundary) globalErrorBoundary.destroy();
        });
    </script>
</body>
</html>