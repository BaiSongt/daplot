<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaPlot - å¯è§†åŒ–ç»˜å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.26.0/plotly.min.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            background: #f8f9fa;
        }

        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            flex-shrink: 0;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            transition: width 0.3s ease;
            padding: 15px;
            display: flex;
            flex-direction: column;
            font-size: 12px;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: #333;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .sidebar-header h1 {
            font-size: 1.3rem;
            margin: 0;
            font-weight: 600;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background: #343a40;
            color: white;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            font-size: 11px;
        }
        
        .main-content {
            width: 100%;
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
        }

        .nav-bar {
            background: none;
            border-radius: 0;
            padding: 0;
            margin-bottom: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #666;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: rgba(74, 144, 226, 0.1);
            color: #4a90e2;
            transform: translateX(3px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .nav-btn i {
            margin-right: 10px;
            font-size: 16px;
            width: 16px;
            text-align: center;
        }

        .controls-panel {
            background: white;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            height: fit-content;
            border: 1px solid #e9ecef;
        }

        .chart-area {
            flex: 1;
            background: white;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
            min-height: 600px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #e9ecef;
        }

        .section h3 {
            margin-bottom: 12px;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            color: #495057;
            font-weight: 500;
            font-size: 11px;
        }

        .form-control {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 11px;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .tag {
            background: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .tag:hover {
            background: #dee2e6;
        }

        .tag.selected {
            background: #4a90e2;
            color: white;
            border-color: #357abd;
        }

        .btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            background: #357abd;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .chart-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .toolbar-btn {
            background: white;
            border: 1px solid #ced4da;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .toolbar-btn:hover {
            background: #e9ecef;
        }

        .toolbar-btn.active {
            background: #4a90e2;
            color: white;
            border-color: #357abd;
        }

        #plotDiv {
            width: 100%;
            height: 500px;
        }

        .no-data-message {
            text-align: center;
            color: #6c757d;
            padding: 50px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>DaPlot</h1>
            </div>
            <nav class="nav-bar">
                <a href="index.html" class="nav-btn">
                    <i>ğŸ </i>
                    <span>é¦–é¡µ</span>
                </a>
                <a href="data_integrated.html" class="nav-btn">
                    <i>ğŸ“Š</i>
                    <span>æ•°æ®æ“ä½œ</span>
                </a>
                <a href="visualization.html" class="nav-btn active">
                    <i>ğŸ“ˆ</i>
                    <span>å¯è§†åŒ–ç»˜å›¾</span>
                </a>
                <a href="donate.html" class="nav-btn">
                    <i>â¤ï¸</i>
                    <span>æèµ æ”¯æŒ</span>
                </a>
            </nav>
        </div>

        <div class="content-area">
            <div class="main-content">
                <div class="controls-panel">
                    <div class="status-message" id="statusMessage"></div>

                    <div class="section">
                        <h3 style="font-size: 13px; margin-bottom: 8px;">ğŸ“ æ–‡ä»¶é€‰æ‹©</h3>
                        <div class="form-group">
                            <label for="fileSelector">é€‰æ‹©æ•°æ®æ–‡ä»¶:</label>
                            <select id="fileSelector" class="form-control" onchange="switchFile()">
                                <option value="">è¯·é€‰æ‹©æ•°æ®æ–‡ä»¶</option>
                            </select>
                        </div>
                        <div id="currentFileInfo" style="font-size: 10px; color: #666; margin-top: 3px; padding: 3px; background: #f8f9fa; border-radius: 2px;"></div>
                    </div>

                    <div class="section">
                        <h3 style="font-size: 13px; margin-bottom: 8px;">ğŸ¯ é¡¹ç›®é€‰æ‹©</h3>
                        <div id="projectTags" class="tag-container">
                            <!-- é¡¹ç›®æ ‡ç­¾å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="section">
                        <h3>âš™ï¸ çŠ¶æ€å˜é‡é€‰æ‹©</h3>
                        <div class="form-group">
                            <label for="statusColumn">çŠ¶æ€é‡åˆ—:</label>
                            <select id="statusColumn" class="form-control">
                                <option value="">è¯·é€‰æ‹©çŠ¶æ€é‡åˆ—</option>
                            </select>
                        </div>
                        <div id="statusTags" class="tag-container">
                            <!-- çŠ¶æ€å€¼æ ‡ç­¾å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="section">
                        <h3>ğŸ“Š åæ ‡è½´è®¾ç½®</h3>
                        <div class="form-group">
                            <label for="xAxis">Xè½´:</label>
                            <select id="xAxis" class="form-control">
                                <option value="">è¯·é€‰æ‹©Xè½´å˜é‡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="yAxis">Yè½´:</label>
                            <select id="yAxis" class="form-control">
                                <option value="">è¯·é€‰æ‹©Yè½´å˜é‡</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn" id="generateChart" onclick="generateChart()" disabled>
                        ç”Ÿæˆå›¾è¡¨
                    </button>
                </div>

                <div class="chart-area">
                    <div class="chart-toolbar" id="chartToolbar" style="display: none;">
                        <button class="toolbar-btn" onclick="resetZoom()">ğŸ” é‡ç½®ç¼©æ”¾</button>
                        <button class="toolbar-btn" onclick="downloadPNG()">ğŸ“· ä¿å­˜PNG</button>
                        <button class="toolbar-btn" onclick="downloadSVG()">ğŸ¨ ä¿å­˜SVG</button>
                    </div>
                    <div id="plotDiv">
                        <div class="no-data-message">
                            <h3 style="font-size: 13px; margin-bottom: 8px;">ğŸ“ˆ å›¾è¡¨åŒºåŸŸ</h3>
                            <p>è¯·å…ˆé€‰æ‹©é¡¹ç›®ã€çŠ¶æ€å˜é‡å’Œåæ ‡è½´ï¼Œç„¶åç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let fileId = null;
        let headers = [];
        let selectedProjects = [];
        let selectedStatus = [];
        let selectedStatusColumn = '';
        let allData = [];
        let currentPlot = null;

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showMessage('æ­£åœ¨åˆå§‹åŒ–é¡µé¢...', 'info');
            
            // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
            setTimeout(() => {
                loadFileList();
                loadDataFromStorage();
                if (fileId) {
                    initializeVisualization();
                } else {
                    showMessage('è¯·é€‰æ‹©æ•°æ®æ–‡ä»¶æˆ–å…ˆä¸Šä¼ æ•°æ®', 'info');
                }
            }, 100);
        });

        async function loadFileList() {
             try {
                 const response = await fetch('http://localhost:8001/api/files');
                 if (!response.ok) {
                     throw new Error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                 }
                 
                 const data = await response.json();
                 const fileSelector = document.getElementById('fileSelector');
                 
                 console.log('åŠ è½½æ–‡ä»¶åˆ—è¡¨:', data);
                 
                 // æ¸…ç©ºç°æœ‰é€‰é¡¹
                 fileSelector.innerHTML = '<option value="">è¯·é€‰æ‹©æ•°æ®æ–‡ä»¶</option>';
                 
                 // æ·»åŠ æ–‡ä»¶é€‰é¡¹
                 if (data.files && data.files.length > 0) {
                     data.files.forEach(file => {
                         const option = document.createElement('option');
                         option.value = file.file_id;
                         const displayName = file.filename || file.original_filename || `æ–‡ä»¶ ${file.file_id.substring(0, 8)}...`;
                         option.textContent = `${displayName} (${file.rows}è¡ŒÃ—${file.columns}åˆ—)`;
                         fileSelector.appendChild(option);
                     });
                 } else {
                     const option = document.createElement('option');
                     option.value = '';
                     option.textContent = 'æš‚æ— å¯ç”¨æ–‡ä»¶';
                     option.disabled = true;
                     fileSelector.appendChild(option);
                 }
                 
                 // å¦‚æœæœ‰å½“å‰æ–‡ä»¶IDï¼Œé€‰ä¸­å®ƒ
                 if (fileId) {
                     fileSelector.value = fileId;
                     updateCurrentFileInfo();
                 }
                 
             } catch (error) {
                 console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                 showMessage('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
             }
         }

        async function switchFile() {
            const fileSelector = document.getElementById('fileSelector');
            const selectedFileId = fileSelector.value;
            
            if (!selectedFileId) {
                fileId = null;
                headers = [];
                clearVisualization();
                return;
            }
            
            try {
                showMessage('æ­£åœ¨åˆ‡æ¢æ–‡ä»¶...', 'info');
                
                // è·å–æ–‡ä»¶æ•°æ®
                const response = await fetch(`http://localhost:8001/api/file/${selectedFileId}`);
                if (!response.ok) {
                    throw new Error('è·å–æ–‡ä»¶æ•°æ®å¤±è´¥');
                }
                
                const fileData = await response.json();
                
                // æ›´æ–°å…¨å±€å˜é‡
                fileId = selectedFileId;
                headers = fileData.headers || [];
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('fileId', fileId);
                localStorage.setItem('headers', JSON.stringify(headers));
                
                // æ›´æ–°ç•Œé¢
                updateCurrentFileInfo();
                populateAxisSelectors();
                populateStatusColumnSelector();
                clearVisualization();
                
                // é‡æ–°åˆå§‹åŒ–å¯è§†åŒ–
                if (fileId) {
                    await initializeVisualization();
                }
                
                showMessage('æ–‡ä»¶åˆ‡æ¢æˆåŠŸ', 'success');
                
            } catch (error) {
                console.error('åˆ‡æ¢æ–‡ä»¶å¤±è´¥:', error);
                showMessage('åˆ‡æ¢æ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        function updateCurrentFileInfo() {
            const fileSelector = document.getElementById('fileSelector');
            const currentFileInfo = document.getElementById('currentFileInfo');
            
            if (fileSelector.value && headers.length > 0) {
                const selectedOption = fileSelector.options[fileSelector.selectedIndex];
                currentFileInfo.textContent = `å·²é€‰æ‹©: ${selectedOption.textContent}`;
                currentFileInfo.style.color = '#28a745';
            } else {
                currentFileInfo.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                currentFileInfo.style.color = '#6c757d';
            }
        }

        function clearVisualization() {
            // æ¸…ç©ºé¡¹ç›®å’ŒçŠ¶æ€é€‰æ‹©
            selectedProjects = [];
            selectedStatus = [];
            selectedStatusColumn = '';
            allData = [];
            
            // æ¸…ç©ºç•Œé¢
            document.getElementById('projectTags').innerHTML = '';
            document.getElementById('statusTags').innerHTML = '';
            document.getElementById('statusColumn').value = '';
            document.getElementById('xAxis').value = '';
            document.getElementById('yAxis').value = '';
            
            // æ¸…ç©ºå›¾è¡¨
            const plotDiv = document.getElementById('plotDiv');
            plotDiv.innerHTML = `
                <div class="no-data-message">
                    <h3>ğŸ“ˆ å›¾è¡¨åŒºåŸŸ</h3>
                    <p>è¯·å…ˆé€‰æ‹©é¡¹ç›®ã€çŠ¶æ€å˜é‡å’Œåæ ‡è½´ï¼Œç„¶åç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"</p>
                </div>
            `;
            
            document.getElementById('chartToolbar').style.display = 'none';
            document.getElementById('generateChart').disabled = true;
        }

        function loadDataFromStorage() {
            fileId = localStorage.getItem('fileId');
            const headersStr = localStorage.getItem('headers');
            
            console.log('Loading data from storage:');
            console.log('fileId:', fileId);
            console.log('headersStr:', headersStr);
            
            if (headersStr) {
                try {
                    headers = JSON.parse(headersStr);
                    console.log('Parsed headers:', headers);
                    populateAxisSelectors();
                    populateStatusColumnSelector();
                } catch (error) {
                    console.error('Error parsing headers:', error);
                    showMessage('è§£æè¡¨å¤´æ•°æ®å¤±è´¥', 'error');
                }
            } else {
                console.warn('No headers found in localStorage');
                showMessage('æœªæ‰¾åˆ°è¡¨å¤´æ•°æ®ï¼Œè¯·é‡æ–°é€‰æ‹©æ–‡ä»¶', 'error');
            }
        }

        function populateAxisSelectors() {
            const xAxisSelect = document.getElementById('xAxis');
            const yAxisSelect = document.getElementById('yAxis');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            xAxisSelect.innerHTML = '<option value="">è¯·é€‰æ‹©Xè½´å˜é‡</option>';
            yAxisSelect.innerHTML = '<option value="">è¯·é€‰æ‹©Yè½´å˜é‡</option>';

            // æ·»åŠ åˆ—é€‰é¡¹
            headers.forEach(header => {
                const xOption = document.createElement('option');
                xOption.value = header;
                xOption.textContent = header;
                xAxisSelect.appendChild(xOption);

                const yOption = document.createElement('option');
                yOption.value = header;
                yOption.textContent = header;
                yAxisSelect.appendChild(yOption);
            });

            // æ·»åŠ å˜åŒ–ç›‘å¬å™¨
            xAxisSelect.addEventListener('change', checkFormValidity);
            yAxisSelect.addEventListener('change', checkFormValidity);
        }

        function populateStatusColumnSelector() {
            const statusColumnSelect = document.getElementById('statusColumn');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            statusColumnSelect.innerHTML = '<option value="">è¯·é€‰æ‹©çŠ¶æ€é‡åˆ—</option>';
            
            // æ·»åŠ åˆ—é€‰é¡¹
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                statusColumnSelect.appendChild(option);
            });
            
            // æ·»åŠ å˜åŒ–ç›‘å¬å™¨
            statusColumnSelect.addEventListener('change', onStatusColumnChange);
        }

        function onStatusColumnChange() {
            const statusColumnSelect = document.getElementById('statusColumn');
            selectedStatusColumn = statusColumnSelect.value;
            selectedStatus = []; // é‡ç½®çŠ¶æ€å€¼é€‰æ‹©
            
            if (selectedStatusColumn) {
                updateStatusTags();
            } else {
                document.getElementById('statusTags').innerHTML = '<p style="color: #6c757d; font-style: italic;">è¯·å…ˆé€‰æ‹©çŠ¶æ€é‡åˆ—</p>';
            }
            
            checkFormValidity();
        }

        async function initializeVisualization() {
            try {
                showMessage('æ­£åœ¨åŠ è½½æ•°æ®...', 'info');

                // è·å–æ‰€æœ‰æ•°æ®ä»¥æå–å”¯ä¸€é¡¹ç›®
                const response = await fetch('http://localhost:8001/api/filter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: fileId,
                        filters: {} // ä¸åº”ç”¨ä»»ä½•è¿‡æ»¤å™¨ä»¥è·å–æ‰€æœ‰æ•°æ®
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                allData = await response.json();
                generateProjectTags();
                showMessage('æ•°æ®åŠ è½½å®Œæˆ', 'success');

            } catch (error) {
                console.error('Error loading data:', error);
                showMessage('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        function generateProjectTags() {
            const projectColumn = 'Project'; // æ ¹æ®å®é™…æ•°æ®è°ƒæ•´
            const uniqueProjects = [...new Set(allData.map(row => row[projectColumn]).filter(p => p !== null && p !== undefined))];

            const projectTagsContainer = document.getElementById('projectTags');
            projectTagsContainer.innerHTML = '';

            uniqueProjects.forEach(project => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.textContent = project;
                tag.onclick = () => toggleProjectSelection(project, tag);
                projectTagsContainer.appendChild(tag);
            });
        }

        function toggleProjectSelection(project, tagElement) {
            const index = selectedProjects.indexOf(project);
            if (index > -1) {
                selectedProjects.splice(index, 1);
                tagElement.classList.remove('selected');
            } else {
                selectedProjects.push(project);
                tagElement.classList.add('selected');
            }

            updateStatusTags();
            checkFormValidity();
        }

        async function updateStatusTags() {
            if (selectedProjects.length === 0) {
                document.getElementById('statusTags').innerHTML = '<p style="color: #6c757d; font-style: italic;">è¯·å…ˆé€‰æ‹©é¡¹ç›®</p>';
                return;
            }
            
            if (!selectedStatusColumn) {
                document.getElementById('statusTags').innerHTML = '<p style="color: #6c757d; font-style: italic;">è¯·å…ˆé€‰æ‹©çŠ¶æ€é‡åˆ—</p>';
                return;
            }

            try {
                // æ ¹æ®é€‰ä¸­çš„é¡¹ç›®è·å–ç­›é€‰åçš„æ•°æ®
                const response = await fetch('http://localhost:8001/api/filter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: fileId,
                        filters: {
                            'Project': selectedProjects
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const filteredData = await response.json();

                // ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„çŠ¶æ€é‡åˆ—
                const uniqueStatus = [...new Set(filteredData.map(row => row[selectedStatusColumn]).filter(s => s !== null && s !== undefined))];

                const statusTagsContainer = document.getElementById('statusTags');
                statusTagsContainer.innerHTML = '';

                if (uniqueStatus.length === 0) {
                    statusTagsContainer.innerHTML = '<p style="color: #6c757d; font-style: italic;">è¯¥çŠ¶æ€é‡åˆ—æ²¡æœ‰å¯ç”¨çš„å€¼</p>';
                    return;
                }

                uniqueStatus.forEach(status => {
                    const tag = document.createElement('div');
                    tag.className = 'tag';
                    tag.textContent = status;
                    tag.onclick = () => toggleStatusSelection(status, tag);
                    statusTagsContainer.appendChild(tag);
                });

            } catch (error) {
                console.error('Error updating status tags:', error);
                showMessage('æ›´æ–°çŠ¶æ€å˜é‡å¤±è´¥: ' + error.message, 'error');
            }
        }

        function toggleStatusSelection(status, tagElement) {
            const index = selectedStatus.indexOf(status);
            if (index > -1) {
                selectedStatus.splice(index, 1);
                tagElement.classList.remove('selected');
            } else {
                selectedStatus.push(status);
                tagElement.classList.add('selected');
            }

            checkFormValidity();
        }

        function checkFormValidity() {
            const xAxis = document.getElementById('xAxis').value;
            const yAxis = document.getElementById('yAxis').value;
            const generateBtn = document.getElementById('generateChart');

            const isValid = selectedProjects.length > 0 &&
                           selectedStatusColumn &&
                           selectedStatus.length > 0 &&
                           xAxis && yAxis;

            generateBtn.disabled = !isValid;
        }

        async function generateChart() {
            const xAxis = document.getElementById('xAxis').value;
            const yAxis = document.getElementById('yAxis').value;

            if (!xAxis || !yAxis || selectedProjects.length === 0 || !selectedStatusColumn || selectedStatus.length === 0) {
                showMessage('è¯·å®Œæˆæ‰€æœ‰é€‰æ‹©', 'error');
                return;
            }

            try {
                showMessage('æ­£åœ¨ç”Ÿæˆå›¾è¡¨...', 'info');

                const response = await fetch('http://localhost:8001/api/plot_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: fileId,
                        filters: {
                            'Project': selectedProjects,
                            [selectedStatusColumn]: selectedStatus
                        },
                        x_axis: xAxis,
                        y_axis: yAxis
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const plotData = await response.json();
                renderChart(plotData);
                showMessage('å›¾è¡¨ç”ŸæˆæˆåŠŸ', 'success');

            } catch (error) {
                console.error('Error generating chart:', error);
                showMessage('å›¾è¡¨ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function renderChart(plotData) {
            // è·å–è¯¦ç»†æ•°æ®ä»¥ç”Ÿæˆå¤šæ¡æ›²çº¿
            try {
                const response = await fetch('http://localhost:8001/api/filter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: fileId,
                        filters: {
                            'Project': selectedProjects,
                            [selectedStatusColumn]: selectedStatus
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const filteredData = await response.json();
                const traces = [];
                const colors = ['#4a90e2', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e', '#e67e22'];
                let colorIndex = 0;

                // ä¸ºæ¯ä¸ªé¡¹ç›®å’ŒçŠ¶æ€å€¼ç»„åˆåˆ›å»ºä¸€æ¡æ›²çº¿
                selectedProjects.forEach(project => {
                    selectedStatus.forEach(statusValue => {
                        const projectStatusData = filteredData.filter(row => 
                            row['Project'] === project && row[selectedStatusColumn] === statusValue
                        );

                        if (projectStatusData.length > 0) {
                            const xValues = projectStatusData.map(row => row[plotData.x_label]).filter(v => v !== null && v !== undefined);
                            const yValues = projectStatusData.map(row => row[plotData.y_label]).filter(v => v !== null && v !== undefined);

                            if (xValues.length > 0 && yValues.length > 0) {
                                const trace = {
                                    x: xValues,
                                    y: yValues,
                                    mode: 'lines+markers',
                                    type: 'scatter',
                                    name: `${project}-${selectedStatusColumn}-${statusValue}`,
                                    line: {
                                        color: colors[colorIndex % colors.length],
                                        width: 2
                                    },
                                    marker: {
                                        color: colors[colorIndex % colors.length],
                                        size: 6
                                    }
                                };
                                traces.push(trace);
                                colorIndex++;
                            }
                        }
                    });
                });

                const layout = {
                    title: {
                        text: `${plotData.x_label}-${plotData.y_label} æ›²çº¿å›¾`,
                        font: { size: 16 }
                    },
                    xaxis: {
                        title: plotData.x_label,
                        showgrid: true,
                        gridcolor: '#e9ecef'
                    },
                    yaxis: {
                        title: plotData.y_label,
                        showgrid: true,
                        gridcolor: '#e9ecef'
                    },
                    plot_bgcolor: 'white',
                    paper_bgcolor: 'white',
                    margin: { t: 50, r: 50, b: 50, l: 50 },
                    legend: {
                        x: 1,
                        y: 1,
                        xanchor: 'left',
                        yanchor: 'top'
                    }
                };

                const config = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToAdd: [
                        {
                            name: 'Download PNG',
                            icon: Plotly.Icons.camera,
                            click: function(gd) {
                                Plotly.downloadImage(gd, {format: 'png', width: 800, height: 600, filename: 'chart'});
                            }
                        }
                    ],
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                };

                Plotly.newPlot('plotDiv', traces, layout, config);
                currentPlot = { traces, layout, config };

                // æ˜¾ç¤ºå·¥å…·æ 
                document.getElementById('chartToolbar').style.display = 'flex';
                
            } catch (error) {
                console.error('Error rendering chart:', error);
                showMessage('å›¾è¡¨æ¸²æŸ“å¤±è´¥: ' + error.message, 'error');
            }
        }

        function resetZoom() {
            if (currentPlot) {
                Plotly.relayout('plotDiv', {
                    'xaxis.autorange': true,
                    'yaxis.autorange': true
                });
            }
        }

        function downloadPNG() {
            if (currentPlot) {
                Plotly.downloadImage('plotDiv', {
                    format: 'png',
                    width: 1200,
                    height: 800,
                    filename: 'daplot_chart'
                });
            }
        }

        function downloadSVG() {
            if (currentPlot) {
                Plotly.downloadImage('plotDiv', {
                    format: 'svg',
                    width: 1200,
                    height: 800,
                    filename: 'daplot_chart'
                });
            }
        }

        function showMessage(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';

            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>
