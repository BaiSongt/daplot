<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaPlot - å¯è§†åŒ–ç»˜å›¾</title>
    
    <!-- æœ¬åœ°Plotly.jsåº“ -->
    <script src="assets/libs/plotly.min.js"></script>
    
    <!-- æ–°çš„æ¨¡å—åŒ–æ¶æ„ -->
    <script src="src/utils/constants.js?v=2"></script>
    <script src="src/utils/helpers.js?v=2"></script>
    <script src="src/utils/validators.js?v=2"></script>
    <script src="src/utils/formatters.js?v=2"></script>
    <script src="src/core/ConfigManager.js"></script>
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/ApiClient.js"></script>
    <script src="src/core/AppState.js"></script>
    <script src="src/core/DataManager.js"></script>
    <script src="src/core/ChartEngine.js"></script>
    <script src="src/components/LoadingSpinner.js"></script>
    <script src="src/components/StatusMessage.js"></script>
    <script src="src/components/ErrorBoundary.js"></script>
    <script src="src/components/FileSelector.js"></script>
    <script src="src/components/DataFilter.js"></script>
    <script src="src/components/ChartConfig.js"></script>
    <script src="src/daplot.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            background: #f8f9fa;
            overflow-x: hidden;
        }

        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            flex-shrink: 0;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            transition: width 0.3s ease;
            padding: 15px;
            display: flex;
            flex-direction: column;
            font-size: 12px;
            position: relative;
        }

        .sidebar.collapsed {
            width: 50px;
            padding: 15px 5px;
        }

        .sidebar.collapsed .sidebar-content {
            display: none;
        }

        .sidebar-toggle {
            position: absolute;
            top: 15px;
            right: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
        }

        .sidebar-toggle:hover {
            background: #0056b3;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: #333;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .sidebar-header h1 {
            font-size: 1.3rem;
            margin: 0;
            font-weight: 600;
        }

        .nav-bar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #666;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: rgba(74, 144, 226, 0.1);
            color: #4a90e2;
            transform: translateX(3px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .nav-btn i {
            margin-right: 10px;
            font-size: 16px;
            width: 16px;
            text-align: center;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            align-items: start;
        }

        .controls-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            overflow: hidden;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .chart-area {
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            padding: 20px;
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .chart-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            color: #495057;
        }

        .toolbar-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .chart-container {
            flex: 1;
            min-height: 500px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .no-chart-message {
            text-align: center;
            color: #6c757d;
            padding: 40px;
        }

        .no-chart-message h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .no-chart-message p {
            font-size: 14px;
            line-height: 1.5;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 300px 1fr;
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            
            .sidebar:not(.collapsed) {
                width: 250px;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                padding: 15px;
            }
            
            .controls-panel {
                position: static;
            }
        }

        /* åŠ è½½çŠ¶æ€æ ·å¼ */
        .loading-state {
            opacity: 0.6;
            pointer-events: none;
        }

        /* é”™è¯¯çŠ¶æ€æ ·å¼ */
        .error-state {
            border-color: #dc3545;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <!-- å…¨å±€åŠ è½½é®ç½© -->
    <div id="global-loading" style="display: none;"></div>
    
    <!-- å…¨å±€é”™è¯¯è¾¹ç•Œ -->
    <div id="global-error-boundary" style="display: none;"></div>

    <div class="page-wrapper">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
            
            <div class="sidebar-content">
                <div class="sidebar-header">
                    <h1>DaPlot</h1>
                </div>

                <nav class="nav-bar">
                    <a href="index.html" class="nav-btn">
                        <i>ğŸ </i>
                        <span>é¦–é¡µ</span>
                    </a>
                    <a href="data_integrated.html" class="nav-btn">
                        <i>ğŸ“Š</i>
                        <span>æ•°æ®æ“ä½œ</span>
                    </a>
                    <a href="visualization.html" class="nav-btn active">
                        <i>ğŸ“ˆ</i>
                        <span>å¯è§†åŒ–ç»˜å›¾</span>
                    </a>
                    <a href="prediction.html" class="nav-btn">
                        <i>ğŸ”®</i>
                        <span>æ•°æ®é¢„æµ‹</span>
                    </a>
                    <a href="donate.html" class="nav-btn">
                        <i>â¤ï¸</i>
                        <span>æèµ æ”¯æŒ</span>
                    </a>
                </nav>

                <!-- æ–‡ä»¶é€‰æ‹©å™¨ç»„ä»¶å®¹å™¨ -->
                <div id="file-selector-container"></div>

                <!-- æ•°æ®ç­›é€‰å™¨ç»„ä»¶å®¹å™¨ -->
                <div id="data-filter-container"></div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="content">
            <div class="main-content">
                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="controls-panel">
                    <!-- å›¾è¡¨é…ç½®ç»„ä»¶å®¹å™¨ -->
                    <div id="chart-config-container"></div>
                </div>

                <!-- å›¾è¡¨åŒºåŸŸ -->
                <div class="chart-area">
                    <!-- å›¾è¡¨å·¥å…·æ  -->
                    <div class="chart-toolbar">
                        <button class="toolbar-btn" onclick="resetZoom()" title="é‡ç½®ç¼©æ”¾">
                            ğŸ” é‡ç½®ç¼©æ”¾
                        </button>
                        <button class="toolbar-btn" onclick="downloadChart('png')" title="ä¿å­˜ä¸ºPNG">
                            ğŸ“· ä¿å­˜PNG
                        </button>
                        <button class="toolbar-btn" onclick="downloadChart('svg')" title="ä¿å­˜ä¸ºSVG">
                            ğŸ¨ ä¿å­˜SVG
                        </button>
                        <button class="toolbar-btn" onclick="downloadChart('html')" title="ä¿å­˜ä¸ºHTML">
                            ğŸ“„ ä¿å­˜HTML
                        </button>
                        <button class="toolbar-btn" onclick="toggleFullscreen()" title="å…¨å±æ˜¾ç¤º">
                            â›¶ å…¨å±
                        </button>
                    </div>

                    <!-- å›¾è¡¨å®¹å™¨ -->
                    <div class="chart-container" id="chart-container">
                        <div class="no-chart-message">
                            <h3>ğŸ“ˆ å›¾è¡¨åŒºåŸŸ</h3>
                            <p>è¯·é€‰æ‹©æ•°æ®æ–‡ä»¶å’Œé…ç½®å‚æ•°ï¼Œç„¶åç”Ÿæˆå›¾è¡¨</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let fileSelector = null;
        let dataFilter = null;
        let chartConfig = null;
        let globalLoading = null;
        let globalErrorBoundary = null;
        let currentChart = null;

        // é¡µé¢åˆå§‹åŒ–
        async function initializePage() {
            try {
                console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–å¯è§†åŒ–é¡µé¢...');

                // ç­‰å¾…DaPlotæ ¸å¿ƒæ¨¡å—åŠ è½½å®Œæˆ
                if (typeof window.initializeDaPlot === 'function') {
                    await window.initializeDaPlot();
                }

                // åˆå§‹åŒ–å…¨å±€ç»„ä»¶
                initializeGlobalComponents();

                // åˆå§‹åŒ–é¡µé¢ç»„ä»¶
                await initializePageComponents();

                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                bindEventListeners();

                // æ¢å¤é¡µé¢çŠ¶æ€
                restorePageState();

                console.log('âœ… å¯è§†åŒ–é¡µé¢åˆå§‹åŒ–å®Œæˆ');

            } catch (error) {
                console.error('âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // åˆå§‹åŒ–å…¨å±€ç»„ä»¶
        function initializeGlobalComponents() {
            // å…¨å±€åŠ è½½å™¨
            globalLoading = LoadingSpinner.createGlobal({
                text: 'æ­£åœ¨åŠ è½½...',
                type: 'spinner',
                size: 'large'
            });

            // å…¨å±€é”™è¯¯è¾¹ç•Œ
            globalErrorBoundary = ErrorBoundary.createGlobal({
                showDetails: true,
                allowRetry: true,
                onError: (error, errorInfo) => {
                    console.error('å…¨å±€é”™è¯¯:', error, errorInfo);
                }
            });
        }

        // åˆå§‹åŒ–é¡µé¢ç»„ä»¶
        async function initializePageComponents() {
            // åˆå§‹åŒ–æ–‡ä»¶é€‰æ‹©å™¨
            fileSelector = new FileSelector({
                container: 'file-selector-container',
                showUpload: true,
                showActions: true,
                onSelect: handleFileSelect,
                onDelete: handleFileDelete,
                onRefresh: handleFileRefresh
            });

            // åˆå§‹åŒ–æ•°æ®ç­›é€‰å™¨
            dataFilter = new DataFilter({
                container: 'data-filter-container',
                showPreview: true,
                showClear: true,
                onChange: handleFilterChange,
                onApply: handleFilterApply
            });

            // åˆå§‹åŒ–å›¾è¡¨é…ç½®
            chartConfig = new ChartConfig({
                container: 'chart-config-container',
                showPreview: false, // åœ¨ä¸»å›¾è¡¨åŒºåŸŸæ˜¾ç¤º
                showPresets: true,
                onChange: handleChartConfigChange,
                onApply: handleChartConfigApply
            });
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // ç›‘å¬åº”ç”¨çŠ¶æ€å˜åŒ–
            if (window.appState) {
                window.appState.subscribe('currentFileId', handleFileIdChange);
                window.appState.subscribe('chartConfig', handleChartConfigStateChange);
                window.appState.subscribe('filters', handleFiltersStateChange);
            }

            // ç›‘å¬äº‹ä»¶æ€»çº¿äº‹ä»¶
            if (window.eventBus) {
                window.eventBus.on('file.selected', handleFileSelectedEvent);
                window.eventBus.on('dataFilter.changed', handleDataFilterChangedEvent);
                window.eventBus.on('chartConfig.applied', handleChartConfigAppliedEvent);
                window.eventBus.on('chart.created', handleChartCreatedEvent);
                window.eventBus.on('chart.updated', handleChartUpdatedEvent);
            }

            // çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', debounce(handleWindowResize, 300));

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        async function handleFileSelect(file, fileId) {
            try {
                showLoading('æ­£åœ¨åŠ è½½æ–‡ä»¶æ•°æ®...');

                // æ›´æ–°åº”ç”¨çŠ¶æ€
                if (window.appState) {
                    window.appState.setState({
                        currentFileId: fileId,
                        currentFileData: null
                    });
                }

                // æ›´æ–°æ•°æ®ç­›é€‰å™¨
                if (dataFilter) {
                    dataFilter.setFileId(fileId);
                }

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                StatusMessage.notify(`æ–‡ä»¶ "${file.filename}" åŠ è½½æˆåŠŸ`, 'success');

            } catch (error) {
                console.error('æ–‡ä»¶é€‰æ‹©å¤±è´¥:', error);
                showError('æ–‡ä»¶åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ–‡ä»¶åˆ é™¤å¤„ç†
        function handleFileDelete(fileId) {
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ–‡ä»¶ï¼Œæ¸…é™¤ç›¸å…³çŠ¶æ€
            const currentFileId = window.appState?.getState('currentFileId');
            if (fileId === currentFileId) {
                if (window.appState) {
                    window.appState.setState({
                        currentFileId: null,
                        currentFileData: null,
                        filters: {}
                    });
                }

                // æ¸…é™¤å›¾è¡¨
                clearChart();
            }

            StatusMessage.notify('æ–‡ä»¶åˆ é™¤æˆåŠŸ', 'success');
        }

        // æ–‡ä»¶åˆ·æ–°å¤„ç†
        function handleFileRefresh() {
            StatusMessage.notify('æ–‡ä»¶åˆ—è¡¨å·²åˆ·æ–°', 'info');
        }

        // ç­›é€‰æ¡ä»¶å˜åŒ–å¤„ç†
        function handleFilterChange(filters) {
            // æ›´æ–°åº”ç”¨çŠ¶æ€
            if (window.appState) {
                window.appState.setState({ filters });
            }
        }

        // åº”ç”¨ç­›é€‰å¤„ç†
        async function handleFilterApply(filters) {
            try {
                showLoading('æ­£åœ¨åº”ç”¨ç­›é€‰æ¡ä»¶...');

                // å¦‚æœæœ‰å›¾è¡¨ï¼Œé‡æ–°ç”Ÿæˆ
                if (currentChart) {
                    await generateChart();
                }

                StatusMessage.notify('ç­›é€‰æ¡ä»¶å·²åº”ç”¨', 'success');

            } catch (error) {
                console.error('åº”ç”¨ç­›é€‰å¤±è´¥:', error);
                showError('åº”ç”¨ç­›é€‰å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // å›¾è¡¨é…ç½®å˜åŒ–å¤„ç†
        function handleChartConfigChange(config, key, value) {
            // å®æ—¶æ›´æ–°å›¾è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (currentChart && key !== 'title') {
                debounce(updateChartStyle, 500)();
            }
        }

        // åº”ç”¨å›¾è¡¨é…ç½®å¤„ç†
        async function handleChartConfigApply(config) {
            try {
                showLoading('æ­£åœ¨åº”ç”¨å›¾è¡¨é…ç½®...');

                // ç”Ÿæˆæˆ–æ›´æ–°å›¾è¡¨
                await generateChart();

                StatusMessage.notify('å›¾è¡¨é…ç½®å·²åº”ç”¨', 'success');

            } catch (error) {
                console.error('åº”ç”¨å›¾è¡¨é…ç½®å¤±è´¥:', error);
                showError('åº”ç”¨å›¾è¡¨é…ç½®å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ç”Ÿæˆå›¾è¡¨
        async function generateChart() {
            try {
                const currentFileId = window.appState?.getState('currentFileId');
                if (!currentFileId) {
                    throw new Error('è¯·å…ˆé€‰æ‹©æ•°æ®æ–‡ä»¶');
                }

                const config = chartConfig?.getConfig() || {};
                if (!config.xAxis || !config.yAxis) {
                    throw new Error('è¯·è®¾ç½®Xè½´å’ŒYè½´');
                }

                showLoading('æ­£åœ¨ç”Ÿæˆå›¾è¡¨...');

                // è·å–ç­›é€‰åçš„æ•°æ®
                const filters = window.appState?.getState('filters') || {};
                const plotData = await window.dataManager.getPlotData(
                    currentFileId,
                    filters,
                    config.xAxis,
                    config.yAxis
                );

                // å‡†å¤‡Plotlyæ•°æ®
                const chartData = prepareChartData(plotData, config);
                const layout = prepareChartLayout(config);

                // åˆ›å»ºæˆ–æ›´æ–°å›¾è¡¨
                if (currentChart) {
                    await window.chartEngine.updateChart('chart-container', chartData, layout);
                } else {
                    await window.chartEngine.createChart('chart-container', chartData, layout);
                    currentChart = true;
                }

                // éšè—æ— å›¾è¡¨æ¶ˆæ¯
                const noChartMessage = document.querySelector('.no-chart-message');
                if (noChartMessage) {
                    noChartMessage.style.display = 'none';
                }

            } catch (error) {
                console.error('ç”Ÿæˆå›¾è¡¨å¤±è´¥:', error);
                showError('ç”Ÿæˆå›¾è¡¨å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // å‡†å¤‡å›¾è¡¨æ•°æ®
        function prepareChartData(plotData, config) {
            const data = [{
                x: plotData.x_values,
                y: plotData.y_values,
                mode: getPlotMode(config.chartType),
                type: getPlotType(config.chartType),
                name: config.title || 'æ•°æ®ç³»åˆ—',
                marker: {
                    color: config.colors?.[0] || '#1f77b4',
                    size: config.markerSize || 6,
                    symbol: config.markers || 'circle'
                },
                line: {
                    color: config.colors?.[0] || '#1f77b4',
                    width: config.lineWidth || 2
                }
            }];

            return data;
        }

        // å‡†å¤‡å›¾è¡¨å¸ƒå±€
        function prepareChartLayout(config) {
            return {
                title: {
                    text: config.title || '',
                    font: { size: 16 }
                },
                xaxis: {
                    title: config.xAxis || 'Xè½´',
                    showgrid: config.gridLines !== false
                },
                yaxis: {
                    title: config.yAxis || 'Yè½´',
                    showgrid: config.gridLines !== false
                },
                showlegend: config.showLegend !== false,
                legend: {
                    orientation: getLegendOrientation(config.legendPosition),
                    x: getLegendX(config.legendPosition),
                    y: getLegendY(config.legendPosition)
                },
                margin: { t: 50, r: 50, b: 50, l: 50 },
                autosize: true
            };
        }

        // è·å–ç»˜å›¾æ¨¡å¼
        function getPlotMode(chartType) {
            switch (chartType) {
                case 'scatter': return 'markers';
                case 'line': return 'lines+markers';
                case 'bar': return 'markers';
                default: return 'markers';
            }
        }

        // è·å–ç»˜å›¾ç±»å‹
        function getPlotType(chartType) {
            switch (chartType) {
                case 'bar': return 'bar';
                case 'histogram': return 'histogram';
                default: return 'scatter';
            }
        }

        // è·å–å›¾ä¾‹æ–¹å‘
        function getLegendOrientation(position) {
            return (position === 'top' || position === 'bottom') ? 'h' : 'v';
        }

        // è·å–å›¾ä¾‹Xä½ç½®
        function getLegendX(position) {
            switch (position) {
                case 'inside-topleft':
                case 'inside-bottomleft': return 0;
                case 'inside-topright':
                case 'inside-bottomright': return 1;
                case 'outside-right': return 1.02;
                default: return 0.5;
            }
        }

        // è·å–å›¾ä¾‹Yä½ç½®
        function getLegendY(position) {
            switch (position) {
                case 'inside-topleft':
                case 'inside-topright': return 1;
                case 'inside-bottomleft':
                case 'inside-bottomright': return 0;
                case 'top': return 1.02;
                case 'bottom': return -0.1;
                default: return 0.5;
            }
        }

        // å·¥å…·æ åŠŸèƒ½
        function resetZoom() {
            if (currentChart && window.chartEngine) {
                const chartInfo = window.chartEngine.getChartInfo('chart-container');
                if (chartInfo) {
                    window.Plotly.relayout(chartInfo.container, {
                        'xaxis.autorange': true,
                        'yaxis.autorange': true
                    });
                }
            }
        }

        async function downloadChart(format) {
            if (!currentChart || !window.chartEngine) {
                showError('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾è¡¨');
                return;
            }

            try {
                showLoading(`æ­£åœ¨å¯¼å‡º${format.toUpperCase()}æ ¼å¼...`);

                await window.chartEngine.downloadChart('chart-container', {
                    format: format,
                    filename: `chart-${Date.now()}`,
                    width: 800,
                    height: 600
                });

                StatusMessage.notify(`å›¾è¡¨å·²å¯¼å‡ºä¸º${format.toUpperCase()}æ ¼å¼`, 'success');

            } catch (error) {
                console.error('å¯¼å‡ºå›¾è¡¨å¤±è´¥:', error);
                showError('å¯¼å‡ºå›¾è¡¨å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function toggleFullscreen() {
            const chartContainer = document.getElementById('chart-container');
            if (!document.fullscreenElement) {
                chartContainer.requestFullscreen().catch(err => {
                    console.error('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // æ¸…é™¤å›¾è¡¨
        function clearChart() {
            if (currentChart && window.chartEngine) {
                window.chartEngine.destroyChart('chart-container');
                currentChart = null;
            }

            // æ˜¾ç¤ºæ— å›¾è¡¨æ¶ˆæ¯
            const noChartMessage = document.querySelector('.no-chart-message');
            if (noChartMessage) {
                noChartMessage.style.display = 'block';
            }
        }

        // äº‹ä»¶å¤„ç†å‡½æ•°
        function handleFileIdChange(newFileId, oldFileId) {
            if (newFileId !== oldFileId) {
                clearChart();
            }
        }

        function handleChartConfigStateChange(newConfig, oldConfig) {
            if (chartConfig && JSON.stringify(newConfig) !== JSON.stringify(oldConfig)) {
                chartConfig.setConfig(newConfig);
            }
        }

        function handleFiltersStateChange(newFilters, oldFilters) {
            if (dataFilter && JSON.stringify(newFilters) !== JSON.stringify(oldFilters)) {
                dataFilter.setFilters(newFilters);
            }
        }

        function handleFileSelectedEvent(data) {
            console.log('æ–‡ä»¶é€‰æ‹©äº‹ä»¶:', data);
        }

        function handleDataFilterChangedEvent(data) {
            console.log('æ•°æ®ç­›é€‰å˜æ›´äº‹ä»¶:', data);
        }

        function handleChartConfigAppliedEvent(data) {
            console.log('å›¾è¡¨é…ç½®åº”ç”¨äº‹ä»¶:', data);
        }

        function handleChartCreatedEvent(data) {
            console.log('å›¾è¡¨åˆ›å»ºäº‹ä»¶:', data);
        }

        function handleChartUpdatedEvent(data) {
            console.log('å›¾è¡¨æ›´æ–°äº‹ä»¶:', data);
        }

        function handleWindowResize() {
            if (currentChart && window.chartEngine) {
                window.chartEngine.resizeChart('chart-container');
            }
        }

        function handleKeyboardShortcuts(e) {
            // Ctrl+S: ä¿å­˜å›¾è¡¨
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                downloadChart('png');
            }
            
            // Ctrl+R: åˆ·æ–°æ•°æ®
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                if (fileSelector) {
                    fileSelector.refresh();
                }
            }
        }

        // å·¥å…·å‡½æ•°
        function showLoading(text = 'åŠ è½½ä¸­...') {
            if (globalLoading) {
                globalLoading.show(text);
            }
        }

        function hideLoading() {
            if (globalLoading) {
                globalLoading.hide();
            }
        }

        function showError(message) {
            StatusMessage.error(message, { autoCloseDelay: 5000 });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function restorePageState() {
            // ä»åº”ç”¨çŠ¶æ€æ¢å¤é¡µé¢çŠ¶æ€
            if (window.appState) {
                const currentFileId = window.appState.getState('currentFileId');
                if (currentFileId && fileSelector) {
                    fileSelector.setSelectedFile(currentFileId);
                }

                const filters = window.appState.getState('filters');
                if (filters && dataFilter) {
                    dataFilter.setFilters(filters);
                }

                const chartConfigState = window.appState.getState('chartConfig');
                if (chartConfigState && chartConfig) {
                    chartConfig.setConfig(chartConfigState);
                }
            }
        }

        function updateChartStyle() {
            if (currentChart) {
                generateChart();
            }
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializePage);

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (fileSelector) fileSelector.destroy();
            if (dataFilter) dataFilter.destroy();
            if (chartConfig) chartConfig.destroy();
            if (globalLoading) globalLoading.destroy();
            if (globalErrorBoundary) globalErrorBoundary.destroy();
        });
    </script>
</body>
</html>