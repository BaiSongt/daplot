<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaPlot å¿«é€Ÿä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #chart {
            width: 100%;
            height: 400px;
            border: 1px solid #dee2e6;
            margin: 10px 0;
        }
    </style>
    
    <!-- åŠ è½½å¿«é€Ÿä¿®å¤è„šæœ¬ -->
    <script src="/assets/js/lib-loader.js"></script>
    <script src="/assets/js/data-persistence.js"></script>
    <script src="/assets/js/page-bridge.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ DaPlot å¿«é€Ÿä¿®å¤æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>1. Plotly åŠ è½½æµ‹è¯•</h3>
            <div id="plotly-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
            <button onclick="testPlotlyLoading()">æµ‹è¯• Plotly åŠ è½½</button>
            <div id="chart"></div>
        </div>
        
        <div class="test-section">
            <h3>2. æ•°æ®æŒä¹…åŒ–æµ‹è¯•</h3>
            <div id="persistence-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
            <button onclick="testDataPersistence()">æµ‹è¯•æ•°æ®ä¿å­˜</button>
            <button onclick="testDataRetrieval()">æµ‹è¯•æ•°æ®è¯»å–</button>
            <button onclick="clearTestData()">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
        </div>
        
        <div class="test-section">
            <h3>3. é¡µé¢æ¡¥æ¥æµ‹è¯•</h3>
            <div id="bridge-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
            <button onclick="testPageBridge()">æµ‹è¯•é¡µé¢æ•°æ®å…±äº«</button>
            <button onclick="testNavigation()">æµ‹è¯•é¡µé¢å¯¼èˆª</button>
        </div>
        
        <div class="test-section">
            <h3>4. å­˜å‚¨ä¿¡æ¯</h3>
            <div id="storage-info" class="status info">ç‚¹å‡»åˆ·æ–°æŸ¥çœ‹å­˜å‚¨ä¿¡æ¯</div>
            <button onclick="showStorageInfo()">åˆ·æ–°å­˜å‚¨ä¿¡æ¯</button>
        </div>
    </div>
    
    <script>
        // Plotly åŠ è½½æµ‹è¯•
        async function testPlotlyLoading() {
            const statusEl = document.getElementById('plotly-status');
            statusEl.className = 'status info';
            statusEl.textContent = 'æ­£åœ¨æµ‹è¯• Plotly åŠ è½½...';
            
            try {
                const startTime = Date.now();
                await window.libLoader.loadPlotly();
                const loadTime = Date.now() - startTime;
                
                // åˆ›å»ºæµ‹è¯•å›¾è¡¨
                const data = [{
                    x: [1, 2, 3, 4, 5],
                    y: [2, 4, 3, 5, 6],
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'æµ‹è¯•æ•°æ®'
                }];
                
                const layout = {
                    title: 'Plotly åŠ è½½æˆåŠŸæµ‹è¯•å›¾è¡¨',
                    xaxis: { title: 'X è½´' },
                    yaxis: { title: 'Y è½´' }
                };
                
                Plotly.newPlot('chart', data, layout);
                
                statusEl.className = 'status success';
                statusEl.textContent = `âœ… Plotly åŠ è½½æˆåŠŸï¼è€—æ—¶: ${loadTime}ms`;
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ Plotly åŠ è½½å¤±è´¥: ${error.message}`;
            }
        }
        
        // æ•°æ®æŒä¹…åŒ–æµ‹è¯•
        function testDataPersistence() {
            const statusEl = document.getElementById('persistence-status');
            
            try {
                const testData = {
                    id: 'test_file_' + Date.now(),
                    name: 'æµ‹è¯•æ–‡ä»¶',
                    data: [[1, 2, 3], [4, 5, 6], [7, 8, 9]],
                    timestamp: new Date().toISOString()
                };
                
                const success = window.dataPersistence.saveFileData(testData.id, testData);
                
                if (success) {
                    statusEl.className = 'status success';
                    statusEl.textContent = `âœ… æ•°æ®ä¿å­˜æˆåŠŸï¼æ–‡ä»¶ID: ${testData.id}`;
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'âŒ æ•°æ®ä¿å­˜å¤±è´¥';
                }
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ æ•°æ®ä¿å­˜å¼‚å¸¸: ${error.message}`;
            }
        }
        
        function testDataRetrieval() {
            const statusEl = document.getElementById('persistence-status');
            
            try {
                const fileList = window.dataPersistence.getFileList();
                
                if (fileList.length > 0) {
                    const latestFile = fileList[fileList.length - 1];
                    const data = window.dataPersistence.getFileData(latestFile.id);
                    
                    if (data) {
                        statusEl.className = 'status success';
                        statusEl.textContent = `âœ… æ•°æ®è¯»å–æˆåŠŸï¼æ‰¾åˆ° ${fileList.length} ä¸ªæ–‡ä»¶ï¼Œæœ€æ–°æ–‡ä»¶: ${data.name}`;
                    } else {
                        statusEl.className = 'status error';
                        statusEl.textContent = 'âŒ æ•°æ®è¯»å–å¤±è´¥';
                    }
                } else {
                    statusEl.className = 'status info';
                    statusEl.textContent = 'ğŸ“ æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ•°æ®ï¼Œè¯·å…ˆæµ‹è¯•æ•°æ®ä¿å­˜';
                }
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ æ•°æ®è¯»å–å¼‚å¸¸: ${error.message}`;
            }
        }
        
        function clearTestData() {
            const statusEl = document.getElementById('persistence-status');
            
            try {
                const fileList = window.dataPersistence.getFileList();
                let deletedCount = 0;
                
                fileList.forEach(file => {
                    if (file.id.startsWith('test_file_')) {
                        window.dataPersistence.deleteFileData(file.id);
                        deletedCount++;
                    }
                });
                
                statusEl.className = 'status success';
                statusEl.textContent = `âœ… æ¸…é™¤å®Œæˆï¼åˆ é™¤äº† ${deletedCount} ä¸ªæµ‹è¯•æ–‡ä»¶`;
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ æ¸…é™¤å¤±è´¥: ${error.message}`;
            }
        }
        
        // é¡µé¢æ¡¥æ¥æµ‹è¯•
        function testPageBridge() {
            const statusEl = document.getElementById('bridge-status');
            
            try {
                const testData = {
                    testKey: 'test_value_' + Date.now(),
                    currentPage: 'test_page',
                    timestamp: new Date().toISOString()
                };
                
                window.pageBridge.setSharedData('testData', testData);
                const retrieved = window.pageBridge.getSharedData('testData');
                
                if (retrieved && retrieved.testKey === testData.testKey) {
                    statusEl.className = 'status success';
                    statusEl.textContent = `âœ… é¡µé¢æ•°æ®å…±äº«æµ‹è¯•æˆåŠŸï¼æ•°æ®: ${retrieved.testKey}`;
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'âŒ é¡µé¢æ•°æ®å…±äº«æµ‹è¯•å¤±è´¥';
                }
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ é¡µé¢æ¡¥æ¥å¼‚å¸¸: ${error.message}`;
            }
        }
        
        function testNavigation() {
            const statusEl = document.getElementById('bridge-status');
            
            try {
                // æ¨¡æ‹Ÿå¯¼èˆªï¼ˆä¸å®é™…è·³è½¬ï¼‰
                const testFileId = 'test_file_123';
                window.pageBridge.setSharedData('currentFileId', testFileId);
                window.pageBridge.setSharedData('source', 'test_navigation');
                
                statusEl.className = 'status success';
                statusEl.textContent = `âœ… å¯¼èˆªæ•°æ®è®¾ç½®æˆåŠŸï¼æ–‡ä»¶ID: ${testFileId}`;
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ å¯¼èˆªæµ‹è¯•å¼‚å¸¸: ${error.message}`;
            }
        }
        
        // æ˜¾ç¤ºå­˜å‚¨ä¿¡æ¯
        function showStorageInfo() {
            const statusEl = document.getElementById('storage-info');
            
            try {
                const storageInfo = window.dataPersistence.getStorageInfo();
                const sharedData = window.pageBridge.getSharedData();
                
                statusEl.className = 'status info';
                statusEl.innerHTML = `
                    <strong>æœ¬åœ°å­˜å‚¨ä¿¡æ¯:</strong><br>
                    â€¢ æ–‡ä»¶æ•°é‡: ${storageInfo.fileCount}<br>
                    â€¢ å­˜å‚¨å¤§å°: ${(storageInfo.totalSize / 1024).toFixed(2)} KB<br>
                    â€¢ ä½¿ç”¨ç‡: ${storageInfo.usage}<br>
                    <strong>å…±äº«æ•°æ®:</strong><br>
                    â€¢ æ•°æ®é¡¹: ${Object.keys(sharedData).length}<br>
                    â€¢ å†…å®¹: ${JSON.stringify(sharedData, null, 2).substring(0, 100)}...
                `;
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ è·å–å­˜å‚¨ä¿¡æ¯å¤±è´¥: ${error.message}`;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ§ª DaPlot å¿«é€Ÿä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
            
            // æ£€æŸ¥è„šæœ¬æ˜¯å¦æ­£ç¡®åŠ è½½
            if (window.libLoader && window.dataPersistence && window.pageBridge) {
                console.log('âœ… æ‰€æœ‰å¿«é€Ÿä¿®å¤è„šæœ¬å·²æ­£ç¡®åŠ è½½');
            } else {
                console.error('âŒ éƒ¨åˆ†å¿«é€Ÿä¿®å¤è„šæœ¬åŠ è½½å¤±è´¥');
            }
        });
    </script>
</body>
</html>